{# Partial: SMTP Configuration form for unified settings #}
<div class="card border-success">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-envelope-at me-2"></i>SMTP Configuration</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Configure SMTP server settings for email functionality.</p>
        
        <form method="POST" action="{{ url_for('admin.update_smtp_settings') }}" id="smtpConfigForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="inline" value="1"/>
            
            <!-- SMTP Server Settings -->
            <div class="mb-4">
                <h6 class="fw-bold text-dark mb-3">Server Settings</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="smtp_server" class="form-label">SMTP Server</label>
                        <input type="text" class="form-control" id="smtp_server" name="smtp_server" 
                               value="{{ smtp_config.get('smtp_server', '') if smtp_config else '' }}" 
                               placeholder="smtp.gmail.com">
                    </div>
                    <div class="col-md-6">
                        <label for="smtp_port" class="form-label">SMTP Port</label>
                        <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                               value="{{ smtp_config.get('smtp_port', '587') if smtp_config else '587' }}" 
                               placeholder="587">
                    </div>
                </div>
            </div>

            <!-- Authentication -->
            <div class="mb-4">
                <h6 class="fw-bold text-dark mb-3">Authentication</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="smtp_username" class="form-label">Username / Email</label>
                        <input type="text" class="form-control" id="smtp_username" name="smtp_username" 
                               value="{{ smtp_config.get('smtp_username', '') if smtp_config else '' }}" 
                               placeholder="your-email@gmail.com">
                    </div>
                    <div class="col-md-6">
                        <label for="smtp_password" class="form-label">Password / App Password</label>
                        <input type="password" class="form-control" id="smtp_password" name="smtp_password" 
                               value="{{ smtp_config.get('smtp_password', '') if smtp_config else '' }}" 
                               placeholder="••••••••••••••••">
                        <small class="form-text text-muted">For Gmail, use an App Password</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="smtp_use_tls" name="smtp_use_tls" 
                               {% if smtp_config and smtp_config.get('smtp_use_tls', 'true') == 'true' %}checked{% endif %}>
                        <label class="form-check-label" for="smtp_use_tls">
                            Use TLS/STARTTLS (Recommended)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Email Settings -->
            <div class="mb-4">
                <h6 class="fw-bold text-dark mb-3">Email Settings</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="smtp_from_email" class="form-label">From Email</label>
                        <input type="email" class="form-control" id="smtp_from_email" name="smtp_from_email" 
                               value="{{ smtp_config.get('smtp_from_email', '') if smtp_config else '' }}" 
                               placeholder="noreply@yourlibrary.com">
                    </div>
                    <div class="col-md-6">
                        <label for="smtp_from_name" class="form-label">From Name</label>
                        <input type="text" class="form-control" id="smtp_from_name" name="smtp_from_name" 
                               value="{{ smtp_config.get('smtp_from_name', site_name + ' (MyBibliotheca)') if smtp_config else (site_name + ' (MyBibliotheca)') }}" 
                               placeholder="{{ site_name }} (MyBibliotheca)">
                        <small class="form-text text-muted">Displayed as the sender name in emails</small>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                <button type="button" class="btn btn-outline-success" id="testSmtpBtn">
                    <i class="bi bi-check-circle me-1"></i>Test Connection
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save me-1"></i>Save SMTP Settings
                </button>
            </div>
        </form>

        <div id="smtpTestResult" class="mt-3" style="display:none;"></div>

        <div class="alert alert-info mt-3">
            <strong><i class="bi bi-info-circle me-1"></i>Common Providers:</strong><br>
            <small>
                <strong>Gmail:</strong> smtp.gmail.com:587 (Use App Password)<br>
                <strong>Outlook/Office365:</strong> smtp.office365.com:587<br>
                <strong>Yahoo:</strong> smtp.mail.yahoo.com:587<br>
                <strong>SendGrid:</strong> smtp.sendgrid.net:587<br>
                <strong>Mailgun:</strong> smtp.mailgun.org:587
            </small>
        </div>
    </div>
</div>

<script>
document.getElementById('testSmtpBtn').addEventListener('click', async function() {
    const btn = this;
    const resultDiv = document.getElementById('smtpTestResult');
    const form = document.getElementById('smtpConfigForm');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Testing...';
    resultDiv.style.display = 'none';
    
    try {
        const formData = new FormData(form);
        const response = await fetch("{{ url_for('admin.test_smtp_connection') }}", {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.className = 'alert alert-success mt-3';
            resultDiv.innerHTML = '<i class="bi bi-check-circle me-1"></i>' + data.message;
        } else {
            resultDiv.className = 'alert alert-danger mt-3';
            resultDiv.innerHTML = '<i class="bi bi-x-circle me-1"></i>' + data.message;
        }
        resultDiv.style.display = 'block';
    } catch (error) {
        resultDiv.className = 'alert alert-danger mt-3';
        resultDiv.innerHTML = '<i class="bi bi-x-circle me-1"></i>Error testing connection: ' + error.message;
        resultDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Test Connection';
    }
});

// Handle form submission via AJAX for inline mode
document.getElementById('smtpConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const btn = form.querySelector('button[type="submit"]');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show mt-3';
            alert.innerHTML = '<i class="bi bi-check-circle me-1"></i>SMTP settings saved successfully! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            form.parentNode.insertBefore(alert, form.nextSibling);
            setTimeout(() => alert.remove(), 3000);
        } else {
            throw new Error('Save failed');
        }
    } catch (error) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alert.innerHTML = '<i class="bi bi-x-circle me-1"></i>Error saving settings. Please try again. <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        form.parentNode.insertBefore(alert, form.nextSibling);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save me-1"></i>Save SMTP Settings';
    }
});
</script>
