{% extends "base.html" %}
{% block title %}Edit Book - MyBibliotheca{% endblock %}

{% block extra_head %}
<style>
.contributor-autocomplete {
    position: relative;
}
.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.autocomplete-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.1s ease;
}
.autocomplete-item:hover,
.autocomplete-item.selected {
    background-color: #f8f9fa;
}
.autocomplete-item:last-child {
    border-bottom: none;
}
.autocomplete-item .name {
    font-weight: 500;
    color: #212529;
}
.autocomplete-item .bio {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
    max-height: 2.4em;
    overflow: hidden;
    line-height: 1.2;
}
.autocomplete-item.create-new {
    background-color: #f8f9fa;
    border-top: 2px solid #dee2e6;
    color: #198754;
}
.autocomplete-item.create-new:hover {
    background-color: #e9f7ef;
}
.contributor-tag {
    display: inline-block;
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-radius: 16px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875em;
}
.contributor-tag .remove {
    color: #dc3545;
    cursor: pointer;
    margin-left: 5px;
}

/* Category tag styles - matching contributor layout */
.category-tag {
    display: inline-block;
    background-color: #e7f3ff;
    border: 1px solid #b3d7ff;
    border-radius: 16px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875em;
    color: #0066cc;
}

.category-tag .remove {
    color: #dc3545;
    cursor: pointer;
    margin-left: 5px;
}

.categories-display {
    min-height: 2rem;
    padding: 0.25rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.category-section {
    margin-bottom: 1rem;
}

.category-autocomplete {
    position: relative;
}

/* Category/Genre styles */
.category-autocomplete {
    position: relative;
}
.autocomplete-dropdown-categories {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.category-tag {
    display: inline-block;
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 16px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875em;
    color: #0066cc;
}
.category-tag .remove {
    color: #dc3545;
    cursor: pointer;
    margin-left: 5px;
}

/* Dark mode support for categories */
[data-theme="dark"] .category-tag {
    background: #1a3a5c;
    border-color: #2e5a87;
    color: #87ceeb;
}
[data-theme="dark"] .autocomplete-dropdown-categories {
    background: #2d2d2d;
    border-color: #404040;
}
[data-theme="dark"] .autocomplete-item {
    color: #e0e0e0;
    border-bottom-color: #404040;
}
[data-theme="dark"] .autocomplete-item:hover,
[data-theme="dark"] .autocomplete-item.selected {
    background-color: #404040;
}
[data-theme="dark"] .autocomplete-item.create-new {
    background-color: #2d3d2d;
    border-top-color: #404040;
    color: #86e29b;
}
[data-theme="dark"] .autocomplete-item.create-new:hover {
    background-color: #1f3f1f;
}

/* Enhanced accordion and form styling */
.card {
    border: none;
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.accordion-item {
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.375rem;
}

.accordion-button {
    font-weight: 500;
    border-radius: 0.375rem;
}

.accordion-button:not(.collapsed) {
    color: white;
    background-color: var(--bs-primary);
    box-shadow: none;
}

.accordion-button.bg-primary:not(.collapsed) {
    background-color: var(--bs-primary) !important;
}

.accordion-button.bg-secondary:not(.collapsed) {
    background-color: var(--bs-secondary) !important;
}

.accordion-button.bg-success:not(.collapsed) {
    background-color: var(--bs-success) !important;
}

.accordion-button.bg-info:not(.collapsed) {
    background-color: var(--bs-info) !important;
}

.accordion-button.bg-warning:not(.collapsed) {
    background-color: var(--bs-warning) !important;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.accordion-body {
    padding: 1.25rem;
}

.form-label {
    color: #495057;
    font-size: 0.9rem;
}

.form-label.fw-medium {
    font-weight: 500;
}

.badge {
    font-size: 0.75rem;
}

.btn {
    font-size: 0.9rem;
}

.breadcrumb-item a {
    text-decoration: none;
}

/* Smooth transitions for accordion */
.accordion-collapse {
    transition: height 0.35s ease;
}

/* Better spacing between accordion items */
.accordion-item:not(:last-child) {
    margin-bottom: 0.5rem;
}

/* Dark mode enhancements */
[data-theme="dark"] .text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .form-text {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .form-text a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .card {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-header {
    background-color: rgba(60, 60, 60, 0.8) !important;
    border-bottom-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-body {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-label {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .fw-medium {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .accordion-item {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .accordion-body {
    background-color: rgba(40, 40, 40, 0.8) !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .breadcrumb-item a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .breadcrumb-item.active {
    color: #b0b0b0 !important;
}

/* Form styling for dark mode */
[data-theme="dark"] .form-control,
[data-theme="dark"] .form-select {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-control:focus,
[data-theme="dark"] .form-select:focus {
    background-color: #2d2d2d !important;
    border-color: #86b7fe !important;
    color: #e0e0e0 !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.library') }}">Library</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.view_book_enhanced', uid=book.uid) }}">{{ book.title }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.view_book_enhanced', uid=book.uid) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Book
            </a>
        </div>
    </div>
    
    <form method="post" id="editBookForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-12">
                <!-- Accordion for all edit sections -->
                <div class="accordion" id="editBookAccordion">
                    <!-- Basic Information -->
                    <div class="accordion-item shadow-sm mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-secondary text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseBasicInfo" 
                                    aria-expanded="true" aria-controls="collapseBasicInfo">
                                <i class="bi bi-book me-2"></i>Basic Information
                            </button>
                        </h2>
                        <div id="collapseBasicInfo" class="accordion-collapse collapse show" data-bs-parent="#editBookAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="mb-3">
                                            <label for="title" class="form-label fw-medium">
                                                <i class="bi bi-book me-1"></i>Title <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="title" name="title" value="{{ book.title }}" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="subtitle" class="form-label fw-medium">
                                                <i class="bi bi-bookmark me-1"></i>Subtitle
                                            </label>
                                            <input type="text" class="form-control" id="subtitle" name="subtitle" value="{{ book.subtitle or '' }}">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="description" class="form-label fw-medium">
                                                <i class="bi bi-file-text me-1"></i>Description
                                            </label>
                                            <textarea class="form-control" id="description" name="description" rows="4">{{ book.description or '' }}</textarea>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="isbn13" class="form-label fw-medium">
                                                        <i class="bi bi-upc me-1"></i>ISBN-13
                                                    </label>
                                                    <input type="text" class="form-control" id="isbn13" name="isbn13" value="{{ book.isbn13 or '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="isbn10" class="form-label fw-medium">
                                                        <i class="bi bi-upc me-1"></i>ISBN-10
                                                    </label>
                                                    <input type="text" class="form-control" id="isbn10" name="isbn10" value="{{ book.isbn10 or '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="published_date" class="form-label fw-medium">
                                                        <i class="bi bi-calendar me-1"></i>Published Date
                                                    </label>
                                                    <input type="text" class="form-control" id="published_date" name="published_date" 
                                                           value="{{ book.published_date or '' }}" placeholder="YYYY or YYYY-MM-DD">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="page_count" class="form-label fw-medium">
                                                        <i class="bi bi-file-earmark-text me-1"></i>Page Count
                                                    </label>
                                                    <input type="number" class="form-control" id="page_count" name="page_count" value="{{ book.page_count or '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="publisher" class="form-label fw-medium">
                                                        <i class="bi bi-building me-1"></i>Publisher
                                                    </label>
                                                    <input type="text" class="form-control" id="publisher" name="publisher" 
                                                           value="{{ book.publisher.name if book.publisher and book.publisher.name else book.publisher or '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="language" class="form-label fw-medium">
                                                        <i class="bi bi-translate me-1"></i>Language
                                                    </label>
                                                    <select class="form-select" id="language" name="language">
                                                        <option value="en" {% if book.language == 'en' or not book.language %}selected{% endif %}>English</option>
                                                        <option value="es" {% if book.language == 'es' %}selected{% endif %}>Spanish</option>
                                                        <option value="fr" {% if book.language == 'fr' %}selected{% endif %}>French</option>
                                                        <option value="de" {% if book.language == 'de' %}selected{% endif %}>German</option>
                                                        <option value="it" {% if book.language == 'it' %}selected{% endif %}>Italian</option>
                                                        <option value="pt" {% if book.language == 'pt' %}selected{% endif %}>Portuguese</option>
                                                        <option value="ru" {% if book.language == 'ru' %}selected{% endif %}>Russian</option>
                                                        <option value="ja" {% if book.language == 'ja' %}selected{% endif %}>Japanese</option>
                                                        <option value="ko" {% if book.language == 'ko' %}selected{% endif %}>Korean</option>
                                                        <option value="zh" {% if book.language == 'zh' %}selected{% endif %}>Chinese</option>
                                                        <option value="other" {% if book.language == 'other' %}selected{% endif %}>Other</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% from 'macros/cover_input.html' import render_cover_input %}
                                        {{ render_cover_input(book) }}
                                        
                                        <!-- Series Information (with autocomplete create/search) -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3 position-relative">
                                                    <label for="series_input_edit" class="form-label fw-medium">
                                                        <i class="bi bi-collection me-1"></i>Series
                                                    </label>
                                                    <div id="series-autocomplete-wrapper-edit" class="position-relative">
                                                        <span id="series-debug-indicator" style="position:absolute; top:-0.75rem; right:0; font-size:0.65rem; background:#0d6efd; color:#fff; padding:2px 4px; border-radius:3px; opacity:0.85;">JS</span>
                                                        <input type="text" class="form-control" id="series_input_edit" name="series" autocomplete="off"
                                                               value="{{ book.series.name if book.series and book.series.name else book.series or '' }}"
                                                               placeholder="Type to search or press Enter to create">
                                                        <div id="series-autocomplete-dropdown-edit" class="list-group shadow-sm" style="position:absolute; top:100%; left:0; right:0; z-index:1030; max-height:260px; overflow-y:auto; display:none;"></div>
                                                        <input type="hidden" name="series_id" id="series_id" value="{{ book.series.id if book.series and book.series.id else '' }}">
                                                    </div>
                                                    <div class="form-text" id="series-help-edit">
                                                        Start typing to search existing series. Press Enter to create a new one if no match appears.
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="series_volume" class="form-label fw-medium">
                                                        <i class="bi bi-hash me-1"></i>Volume
                                                    </label>
                                                    <input type="text" class="form-control" id="series_volume" name="series_volume" 
                                                           value="{{ book.series_volume or '' }}" placeholder="e.g., Book 1, Vol. 2">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="series_order" class="form-label fw-medium">
                                                        <i class="bi bi-list-ol me-1"></i>Order
                                                    </label>
                                                    <input type="number" class="form-control" id="series_order" name="series_order" 
                                                           value="{{ book.series_order or '' }}" min="1" placeholder="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contributors -->
                    <div class="accordion-item shadow-sm mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-primary text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseContributors" 
                                    aria-expanded="false" aria-controls="collapseContributors">
                                <i class="bi bi-people me-2"></i>Contributors
                            </button>
                        </h2>
                        <div id="collapseContributors" class="accordion-collapse collapse" data-bs-parent="#editBookAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <!-- Authors -->
                                        <div class="mb-4">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-person-fill me-1"></i> Authors
                                            </label>
                                            <div class="contributor-section" data-type="authored">
                                                <div class="contributors-display mb-2">
                                                    {% for author in book.authors %}
                                                    <div class="contributor-tag" data-id="{{ author.id or '' }}" data-name="{{ author.name }}">
                                                        {{ author.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing author name..." data-type="authored">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Narrators -->
                                        <div class="mb-4">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-headphones me-1"></i> Narrators
                                            </label>
                                            <div class="contributor-section" data-type="narrated">
                                                <div class="contributors-display mb-2">
                                                    {% for narrator in book.narrators %}
                                                    <div class="contributor-tag" data-id="{{ narrator.id or '' }}" data-name="{{ narrator.name }}">
                                                        {{ narrator.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing narrator name..." data-type="narrated">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6">
                                        <!-- Editors -->
                                        <div class="mb-4">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-pencil me-1"></i> Editors
                                            </label>
                                            <div class="contributor-section" data-type="edited">
                                                <div class="contributors-display mb-2">
                                                    {% for editor in book.editors %}
                                                    <div class="contributor-tag" data-id="{{ editor.id or '' }}" data-name="{{ editor.name }}">
                                                        {{ editor.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing editor name..." data-type="edited">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Translators -->
                                        <div class="mb-4">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-translate me-1"></i> Translators
                                            </label>
                                            <div class="contributor-section" data-type="translated">
                                                <div class="contributors-display mb-2">
                                                    {% for translator in book.translators %}
                                                    <div class="contributor-tag" data-id="{{ translator.id or '' }}" data-name="{{ translator.name }}">
                                                        {{ translator.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing translator name..." data-type="translated">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Illustrators -->
                                        <div class="mb-4">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-palette me-1"></i> Illustrators
                                            </label>
                                            <div class="contributor-section" data-type="illustrated">
                                                <div class="contributors-display mb-2">
                                                    {% for illustrator in book.illustrators %}
                                                    <div class="contributor-tag" data-id="{{ illustrator.id or '' }}" data-name="{{ illustrator.name }}">
                                                        {{ illustrator.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing illustrator name..." data-type="illustrated">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Other Contributors -->
                                        <div class="mb-3">
                                            <label class="form-label fw-medium">
                                                <i class="bi bi-people me-1"></i> Other Contributors
                                            </label>
                                            <div class="contributor-section" data-type="contributed">
                                                <div class="contributors-display mb-2">
                                                    {% set other_contributors = book.get_contributors_by_type_str('CONTRIBUTED') if book.get_contributors_by_type_str else [] %}
                                                    {% for contributor in other_contributors %}
                                                    <div class="contributor-tag" data-id="{{ contributor.id or '' }}" data-name="{{ contributor.name }}">
                                                        {{ contributor.name }}
                                                        <span class="remove" onclick="removeContributor(this)">×</span>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="contributor-autocomplete">
                                                    <input type="text" class="form-control contributor-input" 
                                                           placeholder="Start typing contributor name..." data-type="contributed">
                                                    <div class="autocomplete-dropdown"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Genres & Categories -->
                    <div class="accordion-item shadow-sm mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-success text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseGenres" 
                                    aria-expanded="false" aria-controls="collapseGenres">
                                <i class="bi bi-tags me-2"></i>Genres & Categories
                            </button>
                        </h2>
                        <div id="collapseGenres" class="accordion-collapse collapse" data-bs-parent="#editBookAccordion">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label class="form-label fw-medium">
                                        <i class="bi bi-tag-fill me-1"></i> Genres & Categories
                                    </label>
                                    <div class="category-section" data-type="category">
                                        <div class="categories-display mb-2">
                                            {% if book_categories %}
                                                {% for category in book_categories %}
                                                <div class="category-tag" data-id="{{ category.id }}" data-name="{{ category.name }}">
                                                    {{ category.name }}
                                                    <span class="remove" onclick="removeCategory(this)">×</span>
                                                </div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                        <div class="category-autocomplete">
                                            <input type="text" class="form-control category-input" 
                                                   placeholder="Start typing genre or category name..." data-type="category">
                                            <div class="autocomplete-dropdown"></div>
                                        </div>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Type to search existing genres or add new ones. Popular genres: Fiction, Non-fiction, Mystery, Romance, Science Fiction, Fantasy, Biography, History, etc.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reading Status & Ownership -->
                    <div class="accordion-item shadow-sm mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-info text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseStatus" 
                                    aria-expanded="false" aria-controls="collapseStatus">
                                <i class="bi bi-bookmark-fill me-2"></i>Reading Status & Ownership
                            </button>
                        </h2>
                        <div id="collapseStatus" class="accordion-collapse collapse" data-bs-parent="#editBookAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <!-- Reading Status and Ownership -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="reading_status" class="form-label fw-medium">
                                                    <i class="bi bi-book me-1"></i>Reading Status
                                                </label>
                                                <select class="form-select" id="reading_status" name="reading_status">
                                                    <option value="plan_to_read" {% if book.reading_status == 'plan_to_read' %}selected{% endif %}>📚 Plan to Read</option>
                                                    <option value="reading" {% if book.reading_status == 'reading' %}selected{% endif %}>📖 Currently Reading</option>
                                                    <option value="read" {% if book.reading_status == 'read' %}selected{% endif %}>✅ Read</option>
                                                    <option value="on_hold" {% if book.reading_status == 'on_hold' %}selected{% endif %}>⏸️ On Hold</option>
                                                    <option value="did_not_finish" {% if book.reading_status == 'did_not_finish' %}selected{% endif %}>❌ Did Not Finish</option>
                                                    <option value="library_only" {% if book.reading_status == 'library_only' %}selected{% endif %}>📚 Library Only</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="ownership_status" class="form-label fw-medium">
                                                    <i class="bi bi-house me-1"></i>Ownership Status
                                                </label>
                                                <select class="form-select" id="ownership_status" name="ownership_status">
                                                    <option value="owned" {% if book.ownership_status == 'owned' %}selected{% endif %}>🏠 Owned</option>
                                                    <option value="borrowed" {% if book.ownership_status == 'borrowed' %}selected{% endif %}>📚 Borrowed</option>
                                                    <option value="loaned" {% if book.ownership_status == 'loaned' %}selected{% endif %}>📤 Loaned Out</option>
                                                    <option value="wishlist" {% if book.ownership_status == 'wishlist' %}selected{% endif %}>⭐ Wishlist</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="media_type" class="form-label fw-medium">
                                                    <i class="bi bi-collection me-1"></i>Media Type
                                                </label>
                                                <select class="form-select" id="media_type" name="media_type">
                                                    <option value="physical" {% if book.media_type == 'physical' %}selected{% endif %}>📖 Physical Book</option>
                                                    <option value="ebook" {% if book.media_type == 'ebook' %}selected{% endif %}>💻 E-book</option>
                                                    <option value="audiobook" {% if book.media_type == 'audiobook' %}selected{% endif %}>🎧 Audiobook</option>
                                                    <option value="kindle" {% if book.media_type == 'kindle' %}selected{% endif %}>📱 Kindle</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Location and Rating -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="location_id" class="form-label fw-medium">
                                                    <i class="bi bi-geo-alt me-1"></i>Location
                                                </label>
                                                <select class="form-select" id="location_id" name="location_id" data-current-location="{{ book.location_id or '' }}">
                                                    <option value="">Select a location...</option>
                                                    <!-- Locations will be populated by JavaScript -->
                                                </select>
                                                <div class="form-text">
                                                    <a href="{{ url_for('locations.manage_locations') }}" target="_blank" class="text-decoration-none">
                                                        <i class="bi bi-gear me-1"></i>Manage Locations
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="user_rating" class="form-label fw-medium">
                                                    <i class="bi bi-star me-1"></i>My Rating
                                                </label>
                                                <select class="form-select" id="user_rating" name="user_rating">
                                                    <option value="">No Rating</option>
                                                    <option value="1" {% if book.user_rating == 1 %}selected{% endif %}>⭐ 1 Star</option>
                                                    <option value="2" {% if book.user_rating == 2 %}selected{% endif %}>⭐⭐ 2 Stars</option>
                                                    <option value="3" {% if book.user_rating == 3 %}selected{% endif %}>⭐⭐⭐ 3 Stars</option>
                                                    <option value="4" {% if book.user_rating == 4 %}selected{% endif %}>⭐⭐⭐⭐ 4 Stars</option>
                                                    <option value="5" {% if book.user_rating == 5 %}selected{% endif %}>⭐⭐⭐⭐⭐ 5 Stars</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-6">
                                        <!-- Reading Dates -->
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="start_date" class="form-label fw-medium">
                                                    <i class="bi bi-play-circle me-1"></i>Start Date
                                                </label>
                                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                                       value="{{ book.start_date or '' }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="finish_date" class="form-label fw-medium">
                                                    <i class="bi bi-check-circle me-1"></i>Finish Date
                                                </label>
                                                <input type="date" class="form-control" id="finish_date" name="finish_date" 
                                                       value="{{ book.finish_date or '' }}">
                                            </div>
                                        </div>
                                        
                                        <!-- Personal Notes and Tags -->
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="personal_notes" class="form-label fw-medium">
                                                    <i class="bi bi-journal-text me-1"></i>Personal Notes
                                                </label>
                                                <textarea class="form-control" id="personal_notes" name="personal_notes" rows="3" 
                                                          placeholder="Your personal thoughts about this book...">{{ book.personal_notes or '' }}</textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="user_tags" class="form-label fw-medium">
                                                    <i class="bi bi-tags me-1"></i>Personal Tags
                                                </label>
                                                <input type="text" class="form-control" id="user_tags" name="user_tags" 
                                                       placeholder="e.g., favorite, quick-read, beach-book" 
                                                       value="{{ book.user_tags|join(', ') if book.user_tags else '' }}">
                                                <div class="form-text">Enter tags separated by commas</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Metadata -->
                    <div class="accordion-item shadow-sm mb-2">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-warning text-dark" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapseCustomMetadata" 
                                    aria-expanded="false" aria-controls="collapseCustomMetadata">
                                <i class="bi bi-plus-square me-2"></i>Custom Metadata
                            </button>
                        </h2>
                        <div id="collapseCustomMetadata" class="accordion-collapse collapse" data-bs-parent="#editBookAccordion">
                            <div class="accordion-body">
                                <div id="custom-metadata-container">
                                    {% if book.custom_metadata %}
                                        {% for key, value in book.custom_metadata.items() %}
                                        <div class="custom-field mb-3">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control custom-field-name" 
                                                           placeholder="Field name" value="{{ key }}">
                                                </div>
                                                <div class="col-md-7">
                                                    <input type="text" class="form-control custom-field-value" 
                                                           placeholder="Field value" value="{{ value }}">
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-outline-danger btn-sm remove-custom-field">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="add-custom-field">
                                    <i class="bi bi-plus me-1"></i>Add Custom Field
                                </button>
                                <div class="form-text mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Add custom fields like "First Edition", "Signed Copy", "Purchase Price", etc.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Save Actions -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-1"></i> Save Changes
                            </button>
                            <a href="{{ url_for('main.view_book_enhanced', uid=book.uid) }}" class="btn btn-secondary btn-lg">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden inputs for contributors -->
        <div id="contributorInputs"></div>
        
        <!-- Hidden inputs for categories -->
        <div id="categoryInputs"></div>
    </form>
</div>

<script>
// JavaScript loaded for edit_book_enhanced.html

let searchTimeout;
let activeDropdown = null;

// Initialize contributor & series autocomplete (fire immediately if DOM already loaded)
function initEditPageEnhancements(){
    const contributorInputs = document.querySelectorAll('.contributor-input');
    const categoryInputs = document.querySelectorAll('.category-input');
    
    contributorInputs.forEach((input, index) => {
        input.addEventListener('input', handleInput);
        input.addEventListener('keydown', handleKeydown);
        input.addEventListener('blur', handleBlur);
    });
    
    // Initialize category autocomplete with new tag-based system
    categoryInputs.forEach((input, index) => {
        input.addEventListener('input', handleCategoryInput);
        input.addEventListener('keydown', handleCategoryKeydown);
        input.addEventListener('blur', handleCategoryBlur);
    });
    
    // Update hidden inputs on form submission
    const form = document.getElementById('editBookForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            updateHiddenInputs();
            updateCategoryInputs();
        });
    }
    
    // Update hidden inputs on page load
    updateHiddenInputs();
    updateCategoryInputs();
    
    // Load locations for the location dropdown
    loadLocations();
    
    // Initialize custom metadata functionality
    initializeCustomMetadata();
    
    // Initialize accordion behavior
    initializeAccordion();
    initializeSeriesAutocompleteEdit();
    console.debug('[EditPageInit] Enhancements initialized');
}
if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initEditPageEnhancements);
} else {
    initEditPageEnhancements();
}

function initializeAccordion() {
    // Bootstrap accordion should handle this automatically with data-bs-parent,
    // but let's add explicit handling to ensure only one section is open
    const accordionButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
    
    accordionButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Close all other accordion sections when one is opened
            const targetId = this.getAttribute('data-bs-target');
            const allCollapses = document.querySelectorAll('#editBookAccordion .accordion-collapse');
            
            allCollapses.forEach(collapse => {
                if ('#' + collapse.id !== targetId && collapse.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(collapse, {
                        toggle: false
                    });
                    bsCollapse.hide();
                }
            });
        });
    });
}

// ----- Series Autocomplete (Edit Form) -----
function initializeSeriesAutocompleteEdit() {
    const input = document.getElementById('series_input_edit');
    const hiddenId = document.getElementById('series_id');
    const dropdown = document.getElementById('series-autocomplete-dropdown-edit');
    if(!input || !dropdown){ console.warn('[SeriesAutocomplete][Edit] missing elements'); return; }
    let lastQuery='';
    let pending=null; let results=[]; let activeIndex=-1;
    const csrf = (document.querySelector('meta[name="csrf-token"]')||{}).content || '';

    function clearDropdown(){ dropdown.innerHTML=''; dropdown.style.display='none'; results=[]; activeIndex=-1; }
    function escapeHtml(str){return (str||'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}
    function render(list, query){
        if(!list.length && !query){ clearDropdown(); return; }
        if(!list.length && query){
            dropdown.innerHTML = `<button type="button" class="list-group-item list-group-item-action" data-create="1">Create new series \"${escapeHtml(query)}\"</button>`;
            dropdown.style.display='block'; return;
        }
        dropdown.innerHTML = list.map((it,i)=>`
            <button type="button" class="list-group-item list-group-item-action${i===activeIndex?' active':''}" data-id="${it.id}" data-name="${escapeHtml(it.name)}">
              <div class='d-flex justify-content-between align-items-center'>
                <span>${escapeHtml(it.name)}</span>
                <small class='text-muted'>${it.book_count||0} book${(it.book_count||0)===1?'':'s'}</small>
              </div>
            </button>`).join('');
        if(query && !list.find(i=>i.name.toLowerCase()===query.toLowerCase())){
            dropdown.innerHTML += `<button type="button" class="list-group-item list-group-item-action" data-create="1">Create new series \"${escapeHtml(query)}\"</button>`;
        }
        dropdown.style.display='block';
    }
    function debouncedFetch(q){
        if(pending) clearTimeout(pending);
        if(!q){ clearDropdown(); hiddenId.value=''; return; }
        pending=setTimeout(()=>{
            fetch(`/series/search?q=${encodeURIComponent(q)}`,{headers:{'Accept':'application/json'}})
              .then(r=>r.ok?r.json():Promise.reject())
              .then(data=>{ console.debug('[SeriesSearch][Edit]',data); if(!data) return; if(data.success){ results=data.results||[]; } else if(Array.isArray(data)){ results=data; } else { results=[]; } activeIndex=-1; render(results,q); })
              .catch(err=>{ console.warn('[SeriesSearch][Edit] error',err); results=[]; render(results,q); });
        },200);
    }
    function selectResult(r){ hiddenId.value=r.id; input.value=r.name; clearDropdown(); }
    function createSeries(name){ if(!name) return; fetch('/series/create',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':csrf},body:JSON.stringify({name})})
        .then(r=>r.ok?r.json():Promise.reject())
        .then(data=>{ console.debug('[SeriesCreate][Edit]',data); if(data.success && data.series){ hiddenId.value=data.series.id; input.value=data.series.name; clearDropdown(); } })
        .catch(err=>{ console.warn('[SeriesCreate][Edit] error',err); }); }
    input.addEventListener('input', e=>{ hiddenId.value=''; lastQuery=e.target.value.trim(); if(lastQuery.length<2){ clearDropdown(); return; } debouncedFetch(lastQuery); });
    input.addEventListener('keydown', e=>{
        if(e.key==='ArrowDown'){ if(dropdown.style.display==='none') return; e.preventDefault(); const count=Math.max(results.length,1); activeIndex=(activeIndex+1)%count; render(results,lastQuery); }
        else if(e.key==='ArrowUp'){ if(dropdown.style.display==='none') return; e.preventDefault(); const count=Math.max(results.length,1); activeIndex=activeIndex<=0?count-1:activeIndex-1; render(results,lastQuery); }
        else if(e.key==='Enter'){ if(dropdown.style.display==='none') return; e.preventDefault(); if(activeIndex>=0 && results[activeIndex]) selectResult(results[activeIndex]); else if(!results.find(r=>r.name.toLowerCase()===lastQuery.toLowerCase())) createSeries(lastQuery); }
        else if(e.key==='Escape'){ clearDropdown(); }
    });
    dropdown.addEventListener('click', e=>{ const btn=e.target.closest('button'); if(!btn) return; if(btn.dataset.create==='1'){ createSeries(lastQuery); return; } const id=btn.dataset.id; const name=btn.dataset.name; if(id && name){ hiddenId.value=id; input.value=name; clearDropdown(); }});
    document.addEventListener('click', e=>{ if(!dropdown.contains(e.target) && e.target!==input) clearDropdown(); });
    // Expose manual trigger for debugging
    window.__seriesDebugSearch = (q)=>{ input.value=q; const evt=new Event('input'); input.dispatchEvent(evt); };
}
function getCsrfToken(){ const m=document.querySelector('meta[name="csrf-token"]'); return (m&&m.getAttribute('content'))||document.querySelector('input[name="csrf_token"]').value; }

function handleInput(e) {
    const input = e.target;
    const query = input.value.trim();
    const dropdown = input.nextElementSibling;
    
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (query.length < 2) {
        hideDropdown(dropdown);
        return;
    }
    
    // Reduced timeout for more responsive search
    searchTimeout = setTimeout(() => {
        searchPersons(query, dropdown, input);
    }, 150);
}

function handleKeydown(e) {
    const dropdown = e.target.nextElementSibling;
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const selected = dropdown.querySelector('.autocomplete-item.selected');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const next = selected.nextElementSibling || items[0];
            next.classList.add('selected');
        } else if (items.length > 0) {
            items[0].classList.add('selected');
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const prev = selected.previousElementSibling || items[items.length - 1];
            prev.classList.add('selected');
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selected) {
            selectPerson(selected);
        } else {
            // Create new person
            createNewPerson(e.target);
        }
    } else if (e.key === 'Escape') {
        hideDropdown(dropdown);
    }
}

function handleBlur(e) {
    // Delay hiding to allow click on dropdown items
    setTimeout(() => {
        const dropdown = e.target.nextElementSibling;
        hideDropdown(dropdown);
    }, 200);
}

function searchPersons(query, dropdown, input) {
    // Show loading indicator
    dropdown.innerHTML = `
        <div class="autocomplete-item">
            <div class="name text-muted">
                <i class="bi bi-hourglass-split"></i> Searching...
            </div>
        </div>
    `;
    dropdown.style.display = 'block';
    
    fetch(`/api/person/search?q=${encodeURIComponent(query)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(persons => {
            showDropdown(dropdown, persons, input);
        })
        .catch(error => {
            console.error('Error searching persons:', error);
            // Show create option if search fails
            showDropdown(dropdown, [], input);
        });
}

function showDropdown(dropdown, persons, input) {
    if (!dropdown) {
        return;
    }
    
    dropdown.innerHTML = '';
    
    // Show existing persons
    persons.forEach((person, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `
            <div class="name">${person.name}</div>
            ${person.bio ? `<div class="bio">${person.bio}</div>` : ''}
            ${person.book_count > 0 ? `<div class="bio text-muted">${person.book_count} book${person.book_count > 1 ? 's' : ''}</div>` : ''}
        `;
        item.dataset.id = person.id;
        item.dataset.name = person.name;
        item.addEventListener('mousedown', () => selectPerson(item));
        dropdown.appendChild(item);
    });
    
    // Add "Create new" option at the bottom if query exists
    if (input.value.trim()) {
        const createItem = document.createElement('div');
        createItem.className = 'autocomplete-item create-new';
        createItem.innerHTML = `
            <div class="name">
                <i class="bi bi-plus-circle me-1"></i> 
                Add "${input.value.trim()}" as new person
            </div>
        `;
        createItem.dataset.name = input.value.trim();
        createItem.dataset.new = 'true';
        createItem.addEventListener('mousedown', () => selectPerson(createItem));
        dropdown.appendChild(createItem);
    }
    
    dropdown.style.display = 'block';
    activeDropdown = dropdown;
}

function hideDropdown(dropdown) {
    dropdown.style.display = 'none';
    dropdown.innerHTML = '';
    activeDropdown = null;
}

function selectPerson(item) {
    const input = item.closest('.contributor-autocomplete').querySelector('.contributor-input');
    const section = input.closest('.contributor-section');
    const display = section.querySelector('.contributors-display');
    
    let personId = item.dataset.id || '';
    const personName = item.dataset.name;
    const isNew = item.dataset.new === 'true';
    
    // If this is a new person, we'll handle creation during form submission
    // For now, just add it to the UI without an ID
    if (isNew) {
        personId = ''; // Will be created when form is submitted
    }
    
    // Check if person is already added
    const existingTags = display.querySelectorAll('.contributor-tag');
    for (let tag of existingTags) {
        if (tag.dataset.name === personName) {
            input.value = '';
            hideDropdown(item.closest('.autocomplete-dropdown'));
            return; // Person already added
        }
    }
    
    // Add contributor tag
    const tag = document.createElement('div');
    tag.className = 'contributor-tag';
    tag.dataset.id = personId;
    tag.dataset.name = personName;
    tag.dataset.new = isNew ? 'true' : 'false';
    tag.innerHTML = `
        ${personName}
        ${isNew ? '<small class="text-muted"> (new)</small>' : ''}
        <span class="remove" onclick="removeContributor(this)">×</span>
    `;
    
    display.appendChild(tag);
    
    // Clear input
    input.value = '';
    hideDropdown(item.closest('.autocomplete-dropdown'));
    
    // Update hidden inputs
    updateHiddenInputs();
}

function createNewPerson(input) {
    const name = input.value.trim();
    if (!name) return;
    
    selectPerson({
        dataset: { name: name },
        closest: () => input.closest('.contributor-autocomplete').querySelector('.contributor-input')
    });
}

function removeContributor(removeBtn) {
    const contributorTag = removeBtn.closest('.contributor-tag');
    
    if (contributorTag) {
        contributorTag.remove();
        updateHiddenInputs();
    }
}

function updateHiddenInputs() {
    const hiddenContainer = document.getElementById('contributorInputs');
    hiddenContainer.innerHTML = '';
    
    const sections = document.querySelectorAll('.contributor-section');
    let contributorIndex = 0;
    
    console.log(`[CONTRIB_DEBUG] Found ${sections.length} contributor sections`);
    
    sections.forEach((section, sectionIndex) => {
        const type = section.dataset.type;
        const tags = section.querySelectorAll('.contributor-tag');
        
        console.log(`[CONTRIB_DEBUG] Section ${sectionIndex}: type="${type}", ${tags.length} contributors`);
        
        tags.forEach((tag, tagIndex) => {
            const id = tag.dataset.id;
            const name = tag.dataset.name;
            const isNew = tag.dataset.new === 'true';
            
            console.log(`[CONTRIB_DEBUG] Creating inputs for: type="${type}", name="${name}", id="${id}", isNew=${isNew}`);
            
            // Create hidden inputs for this contributor
            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = `contributors[${contributorIndex}][type]`;
            typeInput.value = type;
            
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = `contributors[${contributorIndex}][name]`;
            nameInput.value = name;
            
            const isNewInput = document.createElement('input');
            isNewInput.type = 'hidden';
            isNewInput.name = `contributors[${contributorIndex}][is_new]`;
            isNewInput.value = isNew ? 'true' : 'false';
            
            if (id && !isNew) {
                const idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.name = `contributors[${contributorIndex}][id]`;
                idInput.value = id;
                hiddenContainer.appendChild(idInput);
            }
            
            hiddenContainer.appendChild(typeInput);
            hiddenContainer.appendChild(nameInput);
            hiddenContainer.appendChild(isNewInput);
            
            contributorIndex++;
        });
    });
    
    console.log(`[CONTRIB_DEBUG] Created hidden inputs for ${contributorIndex} contributors total`);
}

// Category autocomplete functions
function handleCategoryInput(e) {
    const input = e.target;
    const query = input.value.trim();
    const dropdown = input.nextElementSibling;
    
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    if (query.length < 2) {
        hideCategoryDropdown(dropdown);
        return;
    }
    
    searchTimeout = setTimeout(() => {
        searchCategories(query, dropdown, input);
    }, 150);
}

function handleCategoryKeydown(e) {
    const dropdown = e.target.nextElementSibling;
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const selected = dropdown.querySelector('.autocomplete-item.selected');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const next = selected.nextElementSibling || items[0];
            next.classList.add('selected');
        } else if (items.length > 0) {
            items[0].classList.add('selected');
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selected) {
            selected.classList.remove('selected');
            const prev = selected.previousElementSibling || items[items.length - 1];
            prev.classList.add('selected');
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selected) {
            selectCategory(selected);
        } else {
            createNewCategory(e.target);
        }
    } else if (e.key === 'Escape') {
        hideCategoryDropdown(dropdown);
    }
}

function handleCategoryBlur(e) {
    setTimeout(() => {
        const dropdown = e.target.nextElementSibling;
        hideCategoryDropdown(dropdown);
    }, 200);
}

function searchCategories(query, dropdown, input) {
    dropdown.innerHTML = `
        <div class="autocomplete-item">
            <div class="name text-muted">
                <i class="bi bi-hourglass-split"></i> Searching genres...
            </div>
        </div>
    `;
    dropdown.style.display = 'block';
    
    fetch(`/genres/api/search?q=${encodeURIComponent(query)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(categories => {
            showCategoryDropdown(dropdown, categories, input);
        })
        .catch(error => {
            console.error('Error searching categories:', error);
            showCategoryDropdown(dropdown, [], input);
        });
}

function showCategoryDropdown(dropdown, categories, input) {
    if (!dropdown) {
        return;
    }
    
    dropdown.innerHTML = '';
    
    // Show existing categories
    categories.forEach((category, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.innerHTML = `
            <div class="name">${category.name}</div>
            ${category.description ? `<div class="bio">${category.description}</div>` : ''}
        `;
        item.dataset.id = category.id;
        item.dataset.name = category.name;
        item.addEventListener('mousedown', () => selectCategory(item));
        dropdown.appendChild(item);
    });
    
    // Add "Create new" option at the bottom if query exists
    if (input.value.trim()) {
        const createItem = document.createElement('div');
        createItem.className = 'autocomplete-item create-new';
        createItem.innerHTML = `
            <div class="name">
                <i class="bi bi-plus-circle me-1"></i> 
                Add "${input.value.trim()}" as new genre
            </div>
        `;
        createItem.dataset.name = input.value.trim();
        createItem.dataset.new = 'true';
        createItem.addEventListener('mousedown', () => selectCategory(createItem));
        dropdown.appendChild(createItem);
    }
    
    dropdown.style.display = 'block';
}

function hideCategoryDropdown(dropdown) {
    dropdown.style.display = 'none';
    dropdown.innerHTML = '';
}

function selectCategory(item) {
    const input = item.closest('.category-autocomplete').querySelector('.category-input');
    const section = input.closest('.category-section');
    const display = section.querySelector('.categories-display');
    
    let categoryId = item.dataset.id || '';
    const categoryName = item.dataset.name;
    const isNew = item.dataset.new === 'true';
    
    // Check if category is already added
    const existingTags = display.querySelectorAll('.category-tag');
    for (let tag of existingTags) {
        if (tag.dataset.name === categoryName) {
            input.value = '';
            hideCategoryDropdown(input.nextElementSibling);
            return;
        }
    }
    
    // Add category tag
    const tag = document.createElement('div');
    tag.className = 'category-tag';
    tag.dataset.id = categoryId;
    tag.dataset.name = categoryName;
    tag.dataset.new = isNew ? 'true' : 'false';
    tag.innerHTML = `
        ${categoryName}
        ${isNew ? '<small class="text-muted"> (new)</small>' : ''}
        <span class="remove" onclick="removeCategory(this)">×</span>
    `;
    
    display.appendChild(tag);
    
    // Clear input
    input.value = '';
    hideCategoryDropdown(input.nextElementSibling);
    
    // Update hidden inputs
    updateCategoryInputs();
}

function createNewCategory(input) {
    const name = input.value.trim();
    if (!name) return;
    
    selectCategory({
        dataset: { name: name, new: 'true' },
        closest: () => input.closest('.category-autocomplete')
    });
}

function removeCategory(removeBtn) {
    const categoryTag = removeBtn.closest('.category-tag');
    
    if (categoryTag) {
        categoryTag.remove();
        updateCategoryInputs();
    }
}

function updateCategoryInputs() {
    const hiddenContainer = document.getElementById('categoryInputs');
    hiddenContainer.innerHTML = '';
    
    const tags = document.querySelectorAll('.category-tag');
    
    tags.forEach((tag, index) => {
        const id = tag.dataset.id;
        const name = tag.dataset.name;
        const isNew = tag.dataset.new === 'true';
        
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = `categories[${index}][name]`;
        nameInput.value = name;
        
        const isNewInput = document.createElement('input');
        isNewInput.type = 'hidden';
        isNewInput.name = `categories[${index}][is_new]`;
        isNewInput.value = isNew ? 'true' : 'false';
        
        if (id && !isNew) {
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = `categories[${index}][id]`;
            idInput.value = id;
            hiddenContainer.appendChild(idInput);
        }
        
        hiddenContainer.appendChild(nameInput);
        hiddenContainer.appendChild(isNewInput);
    });
}

// Load locations for dropdown
function loadLocations() {
    const locationSelect = document.getElementById('location_id');
    if (!locationSelect) return;
    
    const currentLocationId = locationSelect.dataset.currentLocation;
    
    fetch('/locations/api/list')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(locations => {
            // Clear existing options except the first one
            while (locationSelect.children.length > 1) {
                locationSelect.removeChild(locationSelect.lastChild);
            }
            
            // Add location options
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                
                // Select current location if it matches
                if (currentLocationId && currentLocationId == location.id) {
                    option.selected = true;
                }
                
                locationSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading locations:', error);
        });
}

// Custom metadata functionality
function initializeCustomMetadata() {
    const addButton = document.getElementById('add-custom-field');
    if (addButton) {
        addButton.addEventListener('click', addCustomField);
    }
    
    // Initialize remove buttons for existing fields
    document.querySelectorAll('.remove-custom-field').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.custom-field').remove();
        });
    });
}

function addCustomField() {
    const container = document.getElementById('custom-metadata-container');
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'custom-field mb-3';
    fieldDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control custom-field-name" 
                       placeholder="Field name">
            </div>
            <div class="col-md-7">
                <input type="text" class="form-control custom-field-value" 
                       placeholder="Field value">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm remove-custom-field">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(fieldDiv);
    
    // Add remove event listener
    fieldDiv.querySelector('.remove-custom-field').addEventListener('click', function() {
        fieldDiv.remove();
    });
    
    // Focus on the name field
    fieldDiv.querySelector('.custom-field-name').focus();
}
</script>
{% endblock %}
