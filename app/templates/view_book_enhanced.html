{% extends "base.html" %}
{% from 'macros/contributors.html' import display_authors, display_narrators, display_editors %}
{% block title %}{{ book.title }} - Bibliotheca{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.library') }}">Library</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ book.title }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Library
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Content - Single Column -->
        <div class="col-12">
            <!-- üìá BOOK CARD SECTION - Essential overview information -->
            <div class="card shadow-sm mb-4 book-card">
                <div class="card-body position-relative">
                    <!-- Action Icons in Upper Right Corner -->
                    <div class="position-absolute top-0 end-0 mt-2 me-2">
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-outline-primary action-icon-btn" id="editToggle" title="Edit Book Details">
                                <i class="bi bi-pencil" id="edit-icon"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary action-icon-btn" data-bs-toggle="modal" data-bs-target="#coverEditModal" title="Edit Cover">
                                <i class="bi bi-image"></i>
                            </button>
                            <form method="post" action="{{ url_for('main.delete_book', uid=book.uid) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this book? This action cannot be undone.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-outline-danger action-icon-btn" title="Delete Book">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Cover Image -->
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            <div class="position-relative d-inline-block">
                                {% if book.cover_url %}
                                    <img src="{{ book.cover_url }}" alt="{{ book.title }}" 
                                         class="img-fluid rounded shadow-sm" style="max-height: 300px;" id="book-cover"
                                         onerror="this.onerror=null;this.src='{{ url_for('static', filename='bookshelf.png') }}';">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 300px; width: 200px; margin: 0 auto;" id="book-cover">
                                        <i class="bi bi-book text-muted" style="font-size: 4rem;"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Core Book Information -->
                        <div class="col-md-9">
                            <!-- View Mode -->
                            <div class="view-mode">
                                <!-- Title & Subtitle -->
                                <h1 class="h2 mb-2 fw-bold">{{ book.title }}</h1>
                                {% if book.subtitle %}
                                    <h2 class="h5 text-muted mb-3">{{ book.subtitle }}</h2>
                                {% endif %}
                                
                                <!-- Authors -->
                                {% if book.authors %}
                                <div class="mb-3">
                                    <strong class="text-muted me-2">By:</strong>
                                    {% for author in book.authors %}
                                        <a href="#" class="text-decoration-none">{{ author.name }}</a>
                                        {%- if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Basic Metadata Row -->
                                <div class="row mb-3">
                                    {% if book.page_count %}
                                    <div class="col-sm-6 col-md-4 mb-2">
                                        <small class="text-muted d-block">Pages</small>
                                        <span class="fw-medium">{{ book.page_count }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if book.language %}
                                    <div class="col-sm-6 col-md-4 mb-2">
                                        <small class="text-muted d-block">Language</small>
                                        <span class="fw-medium">
                                            {% if book.language == 'en' %}English
                                            {% elif book.language == 'es' %}Spanish
                                            {% elif book.language == 'fr' %}French
                                            {% elif book.language == 'de' %}German
                                            {% elif book.language == 'it' %}Italian
                                            {% elif book.language == 'pt' %}Portuguese
                                            {% elif book.language == 'ru' %}Russian
                                            {% elif book.language == 'ja' %}Japanese
                                            {% elif book.language == 'ko' %}Korean
                                            {% elif book.language == 'zh' %}Chinese
                                            {% else %}{{ book.language }}{% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if book.published_date %}
                                    <div class="col-sm-6 col-md-4 mb-2">
                                        <small class="text-muted d-block">Published</small>
                                        <span class="fw-medium">{{ book.published_date }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Series Information -->
                                {% if book.series %}
                                <div class="mb-3">
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-collection me-1"></i>
                                        {{ book.series.name if book.series.name else book.series }}
                                        {% if book.series_volume %} - Vol. {{ book.series_volume }}{% endif %}
                                        {% if book.series_order %} (#{{ book.series_order }}){% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                <!-- Genres -->
                                {% if book_categories or book.categories %}
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-2">Genres:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if book_categories %}
                                            {% for category in book_categories %}
                                                <span class="badge bg-secondary">{{ category.name }}</span>
                                            {% endfor %}
                                        {% elif book.categories %}
                                            {% for category in book.categories %}
                                                <span class="badge bg-secondary">{{ category.name }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- User Status Section -->
                                <div class="row user-status-section">
                                    <!-- Reading Status -->
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-bookmark-check me-2 text-primary"></i>
                                            <div>
                                                <small class="text-muted d-block">Reading Status</small>
                                                <span class="fw-medium">
                                                    {% if book.reading_status == 'plan_to_read' %}üìö Plan to Read
                                                    {% elif book.reading_status == 'currently_reading' %}üìñ Currently Reading
                                                    {% elif book.reading_status == 'read' %}‚úÖ Read
                                                    {% elif book.reading_status == 'on_hold' %}‚è∏Ô∏è On Hold
                                                    {% elif book.reading_status == 'did_not_finish' %}‚ùå Did Not Finish
                                                    {% elif book.reading_status == 'library_only' %}üìö Library Only
                                                    {% else %}üìö Plan to Read{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Your Rating -->
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-star-fill me-2 text-warning"></i>
                                            <div>
                                                <small class="text-muted d-block">Your Rating</small>
                                                {% if book.user_rating %}
                                                <span class="fw-medium">
                                                    {% for i in range(1, 6) %}
                                                        {% if i <= book.user_rating %}‚≠ê{% endif %}
                                                    {% endfor %}
                                                    ({{ book.user_rating }}/5)
                                                </span>
                                                {% else %}
                                                <span class="text-muted">Not rated</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ownership & Location Section -->
                                <div class="row ownership-section">
                                    <!-- Ownership Status -->
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-house me-2 text-success"></i>
                                            <div>
                                                <small class="text-muted d-block">Ownership</small>
                                                <span class="fw-medium">
                                                    {% if book.ownership_status == 'owned' %}üè† Owned
                                                    {% elif book.ownership_status == 'borrowed' %}üìö Borrowed
                                                    {% elif book.ownership_status == 'loaned' %}üì§ Loaned Out
                                                    {% elif book.ownership_status == 'wishlist' %}‚≠ê Wishlist
                                                    {% else %}üè† Owned{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Media Type -->
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-disc me-2 text-info"></i>
                                            <div>
                                                <small class="text-muted d-block">Format</small>
                                                <span class="fw-medium">
                                                    {% if book.media_type == 'physical' %}üìñ Physical Book
                                                    {% elif book.media_type == 'ebook' %}üíª E-book
                                                    {% elif book.media_type == 'audiobook' %}üéß Audiobook
                                                    {% elif book.media_type == 'kindle' %}üì± Kindle
                                                    {% else %}üìñ Physical Book{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Location -->
                                    {% if book.locations and book.locations|length > 0 %}
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-geo-alt me-2 text-secondary"></i>
                                            <div>
                                                <small class="text-muted d-block">Location</small>
                                                <span class="fw-medium">
                                                    {% if book.locations[0].name %}
                                                        {{ book.locations[0].name }}
                                                    {% elif book.locations[0] is string %}
                                                        {{ book.locations[0] }}
                                                    {% else %}
                                                        {{ book.locations[0] }}
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif book.location_id %}
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-geo-alt me-2 text-secondary"></i>
                                            <div>
                                                <small class="text-muted d-block">Location</small>
                                                <span class="fw-medium">{{ book.location_id }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Edit Mode (Hidden by default) -->
                            <div class="edit-mode" style="display: none;">
                                <form id="book-edit-form" method="post" action="{{ url_for('main.edit_book', uid=book.uid) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    
                                    <!-- Title -->
                                    <div class="mb-3">
                                        <label for="edit-title" class="form-label fw-medium">Title</label>
                                        <input type="text" class="form-control" id="edit-title" name="title" value="{{ book.title }}" required>
                                    </div>
                                    
                                    <!-- Subtitle -->
                                    <div class="mb-3">
                                        <label for="edit-subtitle" class="form-label fw-medium">Subtitle</label>
                                        <input type="text" class="form-control" id="edit-subtitle" name="subtitle" value="{{ book.subtitle or '' }}">
                                    </div>
                                    
                                    <!-- Series Information -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-series" class="form-label fw-medium">Series</label>
                                                <input type="text" class="form-control" id="edit-series" name="series" 
                                                       value="{{ book.series.name if book.series and book.series.name else book.series or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="edit-series-volume" class="form-label fw-medium">Volume</label>
                                                <input type="text" class="form-control" id="edit-series-volume" name="series_volume" 
                                                       value="{{ book.series_volume or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="edit-series-order" class="form-label fw-medium">Order</label>
                                                <input type="number" class="form-control" id="edit-series-order" name="series_order" 
                                                       value="{{ book.series_order or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Authors -->
                                    <div class="mb-3">
                                        <label for="edit-authors" class="form-label fw-medium">Authors</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="edit-authors" name="authors" 
                                                   value="{% for author in book.authors %}{{ author.name }}{% if not loop.last %}, {% endif %}{% endfor %}"
                                                   autocomplete="off">
                                            <div class="form-text">Separate multiple authors with commas</div>
                                            <div id="authors-dropdown" class="autocomplete-dropdown"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Genres & Categories -->
                                    <div class="mb-3">
                                        <label for="edit-categories" class="form-label fw-medium">Genres & Categories</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="edit-categories" name="categories" 
                                                   value="{% if book_categories %}{% for category in book_categories %}{{ category.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% elif book.categories %}{% for category in book.categories %}{{ category.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}"
                                                   autocomplete="off">
                                            <div class="form-text">Separate multiple genres with commas</div>
                                            <div id="categories-dropdown" class="autocomplete-dropdown"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Location -->
                                    <div class="mb-3">
                                        <label for="edit_location_id" class="form-label fw-medium">Location</label>
                                        <select class="form-select" id="edit_location_id" name="location_id" 
                                                data-current-location="{% if book.locations and book.locations|length > 0 %}{% if book.locations[0].name %}{{ book.locations[0].name }}{% else %}{{ book.locations[0] }}{% endif %}{% elif book.location_id %}{{ book.location_id }}{% endif %}">
                                            <option value="">Select location...</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Reading Status -->
                                    <div class="mb-3">
                                        <label for="edit-reading-status" class="form-label fw-medium">Reading Status</label>
                                        <select class="form-select" id="edit-reading-status" name="reading_status">
                                            <option value="plan_to_read" {% if book.reading_status == 'plan_to_read' %}selected{% endif %}>üìö Plan to Read</option>
                                            <option value="reading" {% if book.reading_status == 'reading' %}selected{% endif %}>üìñ Currently Reading</option>
                                            <option value="read" {% if book.reading_status == 'read' %}selected{% endif %}>‚úÖ Read</option>
                                            <option value="on_hold" {% if book.reading_status == 'on_hold' %}selected{% endif %}>‚è∏Ô∏è On Hold</option>
                                            <option value="did_not_finish" {% if book.reading_status == 'did_not_finish' %}selected{% endif %}>‚ùå Did Not Finish</option>
                                            <option value="library_only" {% if book.reading_status == 'library_only' %}selected{% endif %}>üìö Library Only</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Your Rating -->
                                    <div class="mb-3">
                                        <label for="edit-user-rating" class="form-label fw-medium">Your Rating</label>
                                        <select class="form-select" id="edit-user-rating" name="user_rating">
                                            <option value="">No rating</option>
                                            <option value="1" {% if book.user_rating == 1 %}selected{% endif %}>‚≠ê Poor (1 star)</option>
                                            <option value="2" {% if book.user_rating == 2 %}selected{% endif %}>‚≠ê‚≠ê Fair (2 stars)</option>
                                            <option value="3" {% if book.user_rating == 3 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê Good (3 stars)</option>
                                            <option value="4" {% if book.user_rating == 4 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê Very Good (4 stars)</option>
                                            <option value="5" {% if book.user_rating == 5 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent (5 stars)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Save/Cancel Buttons -->
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-1"></i>Save Changes
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="cancelEdit">
                                            <i class="bi bi-x-lg me-1"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Accordion for collapsible sections -->
            <div class="accordion" id="bookAccordion">
                
                <!-- üìñ DESCRIPTION SECTION - Full book description/summary -->
                {% if book.description %}
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-primary text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseDescription" 
                                aria-expanded="false" aria-controls="collapseDescription">
                            <i class="bi bi-file-text me-2"></i>Description
                        </button>
                    </h2>
                    <div id="collapseDescription" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <div class="description-content">
                                {% if book.description|length > 500 %}
                                    <div id="description-short">
                                        <p class="mb-3">{{ book.description[:500]|safe }}...</p>
                                        <button class="btn btn-sm btn-outline-primary expand-description">
                                            <i class="bi bi-chevron-down me-1"></i>Read More
                                        </button>
                                    </div>
                                    <div id="description-full" class="expanded" style="display: none;">
                                        <p class="mb-3">{{ book.description|safe }}</p>
                                        <button class="btn btn-sm btn-outline-primary expand-description">
                                            <i class="bi bi-chevron-up me-1"></i>Show Less
                                        </button>
                                    </div>
                                {% else %}
                                    <p class="mb-0">{{ book.description|safe }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- üîç ADDITIONAL DETAILS SECTION - Technical and publication metadata -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-secondary text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseAdditionalDetails" 
                                aria-expanded="false" aria-controls="collapseAdditionalDetails">
                            <i class="bi bi-info-circle me-2"></i>Additional Details
                        </button>
                    </h2>
                    <div id="collapseAdditionalDetails" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <!-- View Mode -->
                            <div class="additional-details-view-mode">
                                <div class="row">
                                    <!-- Publication Information Column -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-building me-1"></i>Publication Information
                                        </h6>
                                        
                                        {% if book.publisher %}
                                        <div class="mb-2">
                                            <small class="text-muted">Publisher:</small>
                                            <span class="ms-1 fw-medium">{{ book.publisher.name if book.publisher.name else book.publisher }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if book.published_date %}
                                        <div class="mb-2">
                                            <small class="text-muted">Published:</small>
                                            <span class="ms-1 fw-medium">{{ book.published_date }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if book.average_rating %}
                                        <div class="mb-2">
                                            <small class="text-muted">Average Rating:</small>
                                            <span class="ms-1 fw-medium">
                                                {% for i in range(1, 6) %}
                                                    {% if i <= book.average_rating %}‚≠ê{% else %}‚òÜ{% endif %}
                                                {% endfor %}
                                                {{ "%.1f"|format(book.average_rating) }}
                                                {% if book.rating_count %}({{ book.rating_count }} ratings){% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Identifiers & Technical Column -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-fingerprint me-1"></i>Identifiers & Technical
                                        </h6>
                                        
                                        {% if book.isbn13 %}
                                        <div class="mb-2">
                                            <small class="text-muted">ISBN-13:</small>
                                            <span class="ms-1 fw-medium font-monospace">{{ book.isbn13 }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if book.isbn10 and book.isbn10 != book.isbn13 %}
                                        <div class="mb-2">
                                            <small class="text-muted">ISBN-10:</small>
                                            <span class="ms-1 fw-medium font-monospace">{{ book.isbn10 }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if book.asin %}
                                        <div class="mb-2">
                                            <small class="text-muted">ASIN:</small>
                                            <span class="ms-1 fw-medium font-monospace">{{ book.asin }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- External API Links -->
                                        {% if book.google_books_id or book.openlibrary_id %}
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">External Links:</small>
                                            {% if book.google_books_id %}
                                            <a href="https://books.google.com/books?id={{ book.google_books_id }}" 
                                               target="_blank" class="btn btn-sm btn-outline-success me-1 mb-1">
                                                <i class="bi bi-google me-1"></i>Google Books
                                            </a>
                                            {% endif %}
                                            {% if book.openlibrary_id %}
                                            <a href="https://openlibrary.org{{ book.openlibrary_id }}" 
                                               target="_blank" class="btn btn-sm btn-outline-info me-1 mb-1">
                                                <i class="bi bi-book me-1"></i>OpenLibrary
                                            </a>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Record Dates -->
                                        {% if book.created_at or book.updated_at %}
                                        <div class="border-top pt-2 mt-3">
                                            <small class="text-muted d-block mb-1">Record Information:</small>
                                            {% if book.created_at %}
                                            <div class="small text-muted">
                                                Added: {{ book.created_at.strftime('%Y-%m-%d') if book.created_at else 'Unknown' }}
                                            </div>
                                            {% endif %}
                                            {% if book.updated_at %}
                                            <div class="small text-muted">
                                                Updated: {{ book.updated_at.strftime('%Y-%m-%d') if book.updated_at else 'Unknown' }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Edit Mode (Hidden by default) -->
                            <div class="basic-info-edit-mode" style="display: none;">
                                <form method="post" action="{{ url_for('main.edit_book', uid=book.uid) }}" id="basic-info-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    
                                    <!-- Publisher -->
                                    <div class="mb-3">
                                        <label for="publisher" class="form-label fw-medium">Publisher</label>
                                        <input type="text" class="form-control" id="publisher" name="publisher" 
                                               value="{{ book.publisher.name if book.publisher and book.publisher.name else book.publisher or '' }}">
                                    </div>
                                    
                                    <!-- ISBN -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="isbn13" class="form-label fw-medium">ISBN-13</label>
                                                <input type="text" class="form-control" id="isbn13" name="isbn13" 
                                                       value="{{ book.isbn13 or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="isbn10" class="form-label fw-medium">ISBN-10</label>
                                                <input type="text" class="form-control" id="isbn10" name="isbn10" 
                                                       value="{{ book.isbn10 or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Publication Info -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="published_date" class="form-label fw-medium">Published Date</label>
                                                <input type="text" class="form-control" id="published_date" name="published_date" 
                                                       value="{{ book.published_date or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="page_count" class="form-label fw-medium">Pages</label>
                                                <input type="number" class="form-control" id="page_count" name="page_count" 
                                                       value="{{ book.page_count or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Language -->
                                    <div class="mb-3">
                                        <label for="language" class="form-label fw-medium">Language</label>
                                        <input type="text" class="form-control" id="language" name="language" 
                                               value="{{ book.language or '' }}">
                                    </div>
                                    
                                    <!-- Description -->
                                    <div class="mb-3">
                                        <label for="description" class="form-label fw-medium">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="4" 
                                                  placeholder="Book description or summary...">{{ book.description or '' }}</textarea>
                                    </div>
                                    
                                    <!-- API Identifiers -->
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="asin" class="form-label fw-medium">ASIN</label>
                                                <input type="text" class="form-control" id="asin" name="asin" 
                                                       value="{{ book.asin or '' }}" placeholder="Amazon identifier">
                                                <div class="form-text">Amazon Standard Identification Number</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="google_books_id" class="form-label fw-medium">Google Books ID</label>
                                                <input type="text" class="form-control" id="google_books_id" name="google_books_id" 
                                                       value="{{ book.google_books_id or '' }}" placeholder="Google Books identifier">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="openlibrary_id" class="form-label fw-medium">OpenLibrary ID</label>
                                                <input type="text" class="form-control" id="openlibrary_id" name="openlibrary_id" 
                                                       value="{{ book.openlibrary_id or '' }}" placeholder="OpenLibrary identifier">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Global Ratings (Read-only display with option to update) -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="average_rating" class="form-label fw-medium">Average Rating</label>
                                                <input type="number" class="form-control" id="average_rating" name="average_rating" 
                                                       value="{{ book.average_rating or '' }}" step="0.1" min="0" max="5" 
                                                       placeholder="Global average rating">
                                                <div class="form-text">Average rating from APIs (0-5)</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="rating_count" class="form-label fw-medium">Rating Count</label>
                                                <input type="number" class="form-control" id="rating_count" name="rating_count" 
                                                       value="{{ book.rating_count or '' }}" min="0" 
                                                       placeholder="Number of ratings">
                                                <div class="form-text">Total number of ratings</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Ownership and Format -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="ownership_status" class="form-label fw-medium">Ownership</label>
                                                <select class="form-select" id="ownership_status" name="ownership_status">
                                                    <option value="owned" {% if book.ownership_status == 'owned' %}selected{% endif %}>üè† Owned</option>
                                                    <option value="borrowed" {% if book.ownership_status == 'borrowed' %}selected{% endif %}>üìö Borrowed</option>
                                                    <option value="loaned" {% if book.ownership_status == 'loaned' %}selected{% endif %}>üì§ Loaned Out</option>
                                                    <option value="wishlist" {% if book.ownership_status == 'wishlist' %}selected{% endif %}>‚≠ê Wishlist</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="media_type" class="form-label fw-medium">Format</label>
                                                <select class="form-select" id="media_type" name="media_type">
                                                    <option value="physical" {% if book.media_type == 'physical' %}selected{% endif %}>üìñ Physical Book</option>
                                                    <option value="ebook" {% if book.media_type == 'ebook' %}selected{% endif %}>üíª E-book</option>
                                                    <option value="audiobook" {% if book.media_type == 'audiobook' %}selected{% endif %}>üéß Audiobook</option>
                                                    <option value="kindle" {% if book.media_type == 'kindle' %}selected{% endif %}>üì± Kindle</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Borrowing Details -->
                                    <div id="borrowed-section" class="border rounded p-3 mb-3 bg-light" style="display: none;">
                                        <h6 class="text-primary mb-2"><i class="bi bi-arrow-down-circle me-1"></i>Borrowing Details</h6>
                                        <div class="mb-2">
                                            <label for="borrowed_from" class="form-label">Borrowed From</label>
                                            <input type="text" class="form-control form-control-sm" id="borrowed_from" name="borrowed_from" 
                                                   value="{{ book.borrowed_from or '' }}" placeholder="Name or contact">
                                        </div>
                                        <div class="mb-2">
                                            <label for="borrowed_due_date" class="form-label">Due Date</label>
                                            <input type="date" class="form-control form-control-sm" id="borrowed_due_date" name="borrowed_due_date" 
                                                   value="{{ book.borrowed_due_date or '' }}">
                                        </div>
                                    </div>
                                    
                                    <!-- Loaning Details -->
                                    <div id="loaned-section" class="border rounded p-3 mb-3 bg-light" style="display: none;">
                                        <h6 class="text-warning mb-2"><i class="bi bi-arrow-up-circle me-1"></i>Loaning Details</h6>
                                        <div class="mb-2">
                                            <label for="loaned_to" class="form-label">Loaned To</label>
                                            <input type="text" class="form-control form-control-sm" id="loaned_to" name="loaned_to" 
                                                   value="{{ book.loaned_to or '' }}" placeholder="Name or contact">
                                        </div>
                                        <div class="mb-2">
                                            <label for="loaned_due_date" class="form-label">Expected Return</label>
                                            <input type="date" class="form-control form-control-sm" id="loaned_due_date" name="loaned_due_date" 
                                                   value="{{ book.loaned_due_date or '' }}">
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-secondary">
                                            <i class="bi bi-save me-1"></i>Save Basic Information
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- üí≠ PERSONAL NOTES SECTION - User's subjective thoughts and experiences -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-info text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapsePersonalNotes" 
                                aria-expanded="false" aria-controls="collapsePersonalNotes">
                            <i class="bi bi-journal-text me-2"></i>Personal Notes & Reading Experience
                        </button>
                    </h2>
                    <div id="collapsePersonalNotes" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <div class="personal-notes-view-mode">
                                <div class="row">
                                    <!-- Personal Content Column -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-heart me-1"></i>Personal Content
                                        </h6>
                                        
                                        <!-- Personal Notes -->
                                        {% if book.personal_notes %}
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">Notes:</small>
                                            <div class="bg-light rounded p-2">
                                                <p class="small mb-0">{{ book.personal_notes }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Review -->
                                        {% if book.review %}
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">Review:</small>
                                            <div class="bg-light rounded p-2">
                                                <p class="small mb-0">{{ book.review }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Borrowing/Lending Information -->
                                        {% if book.ownership_status in ['borrowed', 'loaned'] %}
                                        <div class="mb-3">
                                            {% if book.ownership_status == 'borrowed' %}
                                            <h6 class="text-primary mb-2"><i class="bi bi-arrow-down-circle me-1"></i>Borrowing Details</h6>
                                            {% if book.borrowed_from %}
                                            <div class="mb-1">
                                                <small class="text-muted">Borrowed from:</small>
                                                <span class="ms-1 fw-medium">{{ book.borrowed_from }}</span>
                                            </div>
                                            {% endif %}
                                            {% if book.borrowed_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Borrowed on:</small>
                                                <span class="ms-1 fw-medium">{{ book.borrowed_date }}</span>
                                            </div>
                                            {% endif %}
                                            {% endif %}
                                            
                                            {% if book.ownership_status == 'loaned' %}
                                            <h6 class="text-warning mb-2"><i class="bi bi-arrow-up-circle me-1"></i>Loaning Details</h6>
                                            {% if book.loaned_to %}
                                            <div class="mb-1">
                                                <small class="text-muted">Loaned to:</small>
                                                <span class="ms-1 fw-medium">{{ book.loaned_to }}</span>
                                            </div>
                                            {% endif %}
                                            {% if book.loaned_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Loaned on:</small>
                                                <span class="ms-1 fw-medium">{{ book.loaned_date }}</span>
                                            </div>
                                            {% endif %}
                                            {% if book.loaned_due_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Expected return:</small>
                                                <span class="ms-1 fw-medium">{{ book.loaned_due_date }}</span>
                                            </div>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Reading Experience Column -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-calendar-check me-1"></i>Reading Experience
                                        </h6>
                                        
                                        <!-- Reading Dates -->
                                        {% if book.start_date or book.finish_date %}
                                        <div class="mb-3">
                                            {% if book.start_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Started:</small>
                                                <span class="ms-1 fw-medium">{{ book.start_date }}</span>
                                            </div>
                                            {% endif %}
                                            {% if book.finish_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Finished:</small>
                                                <span class="ms-1 fw-medium">{{ book.finish_date }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Date Added -->
                                        {% if book.date_added %}
                                        <div class="mb-2">
                                            <small class="text-muted">Date added to library:</small>
                                            <span class="ms-1 fw-medium">{{ book.date_added }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Purchase Information -->
                                        {% if book.purchase_date or book.purchase_price %}
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">Purchase Information:</small>
                                            {% if book.purchase_date %}
                                            <div class="mb-1">
                                                <small class="text-muted">Date:</small>
                                                <span class="ms-1 fw-medium">{{ book.purchase_date }}</span>
                                            </div>
                                            {% endif %}
                                            {% if book.purchase_price %}
                                            <div class="mb-1">
                                                <small class="text-muted">Price:</small>
                                                <span class="ms-1 fw-medium">${{ book.purchase_price }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Reading Progress -->
                                        {% if book.current_page %}
                                        <div class="mb-2">
                                            <small class="text-muted">Current page:</small>
                                            <span class="ms-1 fw-medium">{{ book.current_page }}{% if book.page_count %} of {{ book.page_count }}{% endif %}</span>
                                            {% if book.page_count and book.current_page %}
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     style="width: {{ (book.current_page / book.page_count * 100)|round(1) }}%"
                                                     aria-valuenow="{{ book.current_page }}" aria-valuemin="0" aria-valuemax="{{ book.page_count }}">
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ (book.current_page / book.page_count * 100)|round(1) }}% complete</small>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Condition -->
                                        {% if book.condition %}
                                        <div class="mb-2">
                                            <small class="text-muted">Condition:</small>
                                            <span class="ms-1 fw-medium">{{ book.condition|title }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Tags -->
                                        {% if book.tags %}
                                        <div class="mb-2">
                                            <small class="text-muted d-block mb-1">Personal Tags:</small>
                                            <div>
                                                {% if book.tags is string %}
                                                    {% for tag in book.tags.split(',') %}
                                                        <span class="badge bg-secondary me-1 mb-1">{{ tag.strip() }}</span>
                                                    {% endfor %}
                                                {% elif book.tags is iterable %}
                                                    {% for tag in book.tags %}
                                                        <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if not book.personal_notes and not book.review and not book.start_date and not book.finish_date and not book.current_page and not book.date_added and not book.purchase_price and not book.condition and not book.tags %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-journal-plus mb-2" style="font-size: 2rem;"></i>
                                    <p class="mb-0">No personal notes or reading experience recorded yet.</p>
                                    <small>Click edit to add your thoughts, reading dates, and other personal information.</small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="reading-progress-edit-mode" style="display: none;">
                                <form method="post" action="{{ url_for('main.update_reading_dates', uid=book.uid) }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    
                                    <!-- Reading Dates -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="start_date" class="form-label fw-medium">
                                                    <i class="bi bi-play-circle me-1"></i>Start Date
                                                </label>
                                                <input type="date" class="form-control" id="start_date" name="start_date" 
                                                       value="{{ book.start_date or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="finish_date" class="form-label fw-medium">
                                                    <i class="bi bi-check-circle me-1"></i>Finish Date
                                                </label>
                                                <input type="date" class="form-control" id="finish_date" name="finish_date" 
                                                       value="{{ book.finish_date or '' }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Reading Progress -->
                                    <div class="mb-3">
                                        <label for="current_page" class="form-label fw-medium">
                                            <i class="bi bi-bookmark me-1"></i>Current Page
                                        </label>
                                        <input type="number" class="form-control" id="current_page" name="current_page" 
                                               value="{{ book.current_page or '' }}" min="0" 
                                               {% if book.page_count %}max="{{ book.page_count }}"{% endif %}
                                               placeholder="Page number">
                                        {% if book.page_count %}
                                        <div class="form-text">Out of {{ book.page_count }} pages</div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Acquisition Details -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="date_acquired" class="form-label fw-medium">
                                                    <i class="bi bi-calendar-plus me-1"></i>Date Acquired
                                                </label>
                                                <input type="date" class="form-control" id="date_acquired" name="date_acquired" 
                                                       value="{{ book.date_acquired or '' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="purchase_price" class="form-label fw-medium">
                                                    <i class="bi bi-currency-dollar me-1"></i>Purchase Price
                                                </label>
                                                <input type="number" class="form-control" id="purchase_price" name="purchase_price" 
                                                       value="{{ book.purchase_price or '' }}" step="0.01" min="0" 
                                                       placeholder="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Condition and Tags -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="condition" class="form-label fw-medium">
                                                    <i class="bi bi-star-half me-1"></i>Condition
                                                </label>
                                                <select class="form-select" id="condition" name="condition">
                                                    <option value="">Select condition...</option>
                                                    <option value="new" {% if book.condition == 'new' %}selected{% endif %}>New</option>
                                                    <option value="like_new" {% if book.condition == 'like_new' %}selected{% endif %}>Like New</option>
                                                    <option value="very_good" {% if book.condition == 'very_good' %}selected{% endif %}>Very Good</option>
                                                    <option value="good" {% if book.condition == 'good' %}selected{% endif %}>Good</option>
                                                    <option value="acceptable" {% if book.condition == 'acceptable' %}selected{% endif %}>Acceptable</option>
                                                    <option value="poor" {% if book.condition == 'poor' %}selected{% endif %}>Poor</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="tags" class="form-label fw-medium">
                                                    <i class="bi bi-tags me-1"></i>Personal Tags
                                                </label>
                                                <input type="text" class="form-control" id="tags" name="tags" 
                                                       value="{% if book.tags %}{% if book.tags is string %}{{ book.tags }}{% elif book.tags is iterable %}{{ book.tags|join(', ') }}{% endif %}{% endif %}"
                                                       placeholder="tag1, tag2, tag3">
                                                <div class="form-text">Separate tags with commas</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-save me-1"></i>Update Reading Progress
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Fields -->
                                <!-- Core Personal Content -->
                <div class="accordion-item shadow-sm mb-2">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-warning text-dark" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapseCustomFields" 
                                aria-expanded="false" aria-controls="collapseCustomFields">
                            <i class="bi bi-gear me-2"></i>Custom Fields
                        </button>
                    </h2>
                    <div id="collapseCustomFields" class="accordion-collapse collapse" data-bs-parent="#bookAccordion">
                        <div class="accordion-body">
                            <!-- View Mode -->
                            <div class="custom-fields-view-mode">
                                <!-- Global Custom Fields -->
                                {% if global_metadata_display %}
                                <div class="mb-4">
                                    <h6 class="text-primary fw-bold border-bottom pb-2">
                                        <i class="bi bi-globe me-1"></i>Global Custom Fields
                                        <small class="text-muted fw-normal">(shared across all users)</small>
                                    </h6>
                                    <div class="row">
                                        {% for meta in global_metadata_display %}
                                        <div class="col-md-6 mb-3">
                                            <div class="custom-field-item p-2 bg-light rounded">
                                                <div class="fw-medium text-primary mb-1">{{ meta.display_name }}</div>
                                                <div class="custom-field-value">
                                                    {% if meta.field_type == 'TAGS' %}
                                                        {% if meta.display_value %}
                                                            {% for tag in meta.display_value.split(',') %}
                                                                <span class="badge bg-secondary me-1 mb-1">{{ tag.strip() }}</span>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% elif meta.field_type == 'BOOLEAN' %}
                                                        <i class="bi bi-{{ 'check-circle text-success' if meta.display_value == 'True' else 'x-circle text-danger' }}"></i>
                                                        {{ 'Yes' if meta.display_value == 'True' else 'No' }}
                                                    {% elif meta.field_type == 'TEXTAREA' %}
                                                        <div class="small">{{ meta.display_value[:100] }}{% if meta.display_value|length > 100 %}...{% endif %}</div>
                                                    {% else %}
                                                        {{ meta.display_value | safe }}
                                                    {% endif %}
                                                </div>
                                                {% if meta.description %}
                                                <div class="text-muted small mt-1">{{ meta.description }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Personal Custom Fields -->
                                {% if personal_metadata_display %}
                                <div class="mb-4">
                                    <h6 class="text-success fw-bold border-bottom pb-2">
                                        <i class="bi bi-person me-1"></i>Personal Custom Fields
                                        <small class="text-muted fw-normal">(private to you)</small>
                                    </h6>
                                    <div class="row">
                                        {% for meta in personal_metadata_display %}
                                        <div class="col-md-6 mb-3">
                                            <div class="custom-field-item p-2 bg-light rounded">
                                                <div class="fw-medium text-success mb-1">{{ meta.display_name }}</div>
                                                <div class="custom-field-value">
                                                    {% if meta.field_type == 'TAGS' %}
                                                        {% if meta.display_value %}
                                                            {% for tag in meta.display_value.split(',') %}
                                                                <span class="badge bg-info me-1 mb-1">{{ tag.strip() }}</span>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% elif meta.field_type == 'BOOLEAN' %}
                                                        <i class="bi bi-{{ 'check-circle text-success' if meta.display_value == 'True' else 'x-circle text-danger' }}"></i>
                                                        {{ 'Yes' if meta.display_value == 'True' else 'No' }}
                                                    {% elif meta.field_type == 'TEXTAREA' %}
                                                        <div class="small">{{ meta.display_value[:100] }}{% if meta.display_value|length > 100 %}...{% endif %}</div>
                                                    {% else %}
                                                        {{ meta.display_value | safe }}
                                                    {% endif %}
                                                </div>
                                                {% if meta.description %}
                                                <div class="text-muted small mt-1">{{ meta.description }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Management Actions -->
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="{{ url_for('main.edit_book_custom_metadata', uid=book.uid) }}" class="btn btn-warning">
                                        <i class="bi bi-pencil me-1"></i>Edit Custom Fields
                                    </a>
                                    <a href="{{ url_for('metadata.index') }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-gear me-1"></i>Manage Field Definitions
                                    </a>
                                </div>
                                
                                {% if not global_metadata_display and not personal_metadata_display %}
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-plus-circle mb-2" style="font-size: 2rem;"></i>
                                    <p class="mb-0">No custom fields populated yet.</p>
                                    <p class="small mb-3">Custom fields let you track additional book information like reading moods, content warnings, or personal tags.</p>
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <a href="{{ url_for('main.edit_book_custom_metadata', uid=book.uid) }}" class="btn btn-warning btn-sm">
                                            <i class="bi bi-pencil me-1"></i>Add Custom Data
                                        </a>
                                        <a href="{{ url_for('metadata.index') }}" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-gear me-1"></i>Create Fields
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Search and Filter (for many fields) -->
                            {% if (global_metadata_display|length + personal_metadata_display|length) > 6 %}
                            <div class="custom-fields-search mt-3 pt-3 border-top">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="customFieldSearch" placeholder="Search custom fields...">
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cover Edit Modal -->
<div class="modal fade" id="coverEditModal" tabindex="-1" aria-labelledby="coverEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coverEditModalLabel">
                    <i class="bi bi-image me-2"></i>Edit Book Cover
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <!-- Current Cover Preview -->
                        <div class="text-center mb-3">
                            <h6 class="text-muted mb-2">Current Cover</h6>
                            <div class="cover-preview-container">
                                {% if book.cover_url %}
                                    <img src="{{ book.cover_url }}" alt="{{ book.title }}" 
                                         class="img-fluid rounded shadow-sm" style="max-height: 200px;" id="current-cover-preview">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                         style="height: 200px; width: 133px; margin: 0 auto;" id="current-cover-preview">
                                        <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- New Cover Preview -->
                        <div class="text-center mb-3">
                            <h6 class="text-muted mb-2">New Cover Preview</h6>
                            <div class="cover-preview-container">
                                <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                     style="height: 200px; width: 133px; margin: 0 auto;" id="new-cover-preview">
                                    <i class="bi bi-eye text-muted" style="font-size: 3rem;"></i>
                                    <span class="text-muted ms-2">Preview</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="cover-edit-form" method="post" action="{{ url_for('main.edit_book', uid=book.uid) }}" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="update_cover"/>
                    
                    <!-- Cover Edit Options Accordion -->
                    <div class="accordion" id="coverEditAccordion">
                        <!-- Cover Image URL -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button bg-primary text-white" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseCoverUrl" 
                                        aria-expanded="true" aria-controls="collapseCoverUrl">
                                    <i class="bi bi-link me-2"></i>Cover Image URL
                                </button>
                            </h2>
                            <div id="collapseCoverUrl" class="accordion-collapse collapse show" data-bs-parent="#coverEditAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="cover_url" class="form-label">Enter a direct URL to an image</label>
                                        <div class="input-group">
                                            <input type="url" class="form-control" id="cover_url" name="cover_url" 
                                                   value="{{ book.cover_url or '' }}" placeholder="https://example.com/cover.jpg">
                                            <button type="button" class="btn btn-outline-secondary" id="preview-url-btn">
                                                <i class="bi bi-eye me-1"></i>Preview
                                            </button>
                                        </div>
                                        <div class="form-text">Paste a direct link to an image file (JPG, PNG, GIF, WebP)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload from Device -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-success text-white" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseUpload" 
                                        aria-expanded="false" aria-controls="collapseUpload">
                                    <i class="bi bi-upload me-2"></i>Upload from Device
                                </button>
                            </h2>
                            <div id="collapseUpload" class="accordion-collapse collapse" data-bs-parent="#coverEditAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="cover_file" class="form-label">Choose an image file from your device</label>
                                        <input type="file" class="form-control" id="cover_file" name="cover_file" 
                                               accept="image/*">
                                        <div class="form-text">Supported formats: JPG, PNG, GIF, WebP (max 5MB)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fetch from API -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed bg-info text-white" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapseFetchApi" 
                                        aria-expanded="false" aria-controls="collapseFetchApi">
                                    <i class="bi bi-cloud-download me-2"></i>Fetch from API
                                </button>
                            </h2>
                            <div id="collapseFetchApi" class="accordion-collapse collapse" data-bs-parent="#coverEditAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label class="form-label">Search for cover image automatically</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-info" id="fetch-cover-btn">
                                                <i class="bi bi-search me-1"></i>Search for Cover by ISBN
                                            </button>
                                            {% if book.title and book.authors %}
                                            <button type="button" class="btn btn-outline-info" id="fetch-cover-title-btn">
                                                <i class="bi bi-search me-1"></i>Search by Title & Author
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="form-text">
                                            This will search for a cover image using the book's ISBN or title/author information
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Remove Cover Option -->
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="remove_cover" name="remove_cover">
                            <label class="form-check-label text-danger" for="remove_cover">
                                <i class="bi bi-trash me-1"></i>Remove current cover image
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="submit" form="cover-edit-form" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Update Cover
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit mode toggle functionality for main card
    const editToggle = document.getElementById('editToggle');
    const viewMode = document.querySelector('.view-mode');
    const editMode = document.querySelector('.edit-mode');
    const cancelBtn = document.getElementById('cancelEdit');
    
    // Edit mode toggle functionality for all sections
    const basicInfoViewMode = document.querySelector('.basic-info-view-mode');
    const basicInfoEditMode = document.querySelector('.basic-info-edit-mode');
    const readingProgressViewMode = document.querySelector('.reading-progress-view-mode');
    const readingProgressEditMode = document.querySelector('.reading-progress-edit-mode');
    const personalNotesViewMode = document.querySelector('.personal-notes-view-mode');
    const personalNotesEditMode = document.querySelector('.personal-notes-edit-mode');
    const customMetadataViewMode = document.querySelector('.custom-metadata-view-mode');
    const customMetadataEditMode = document.querySelector('.custom-metadata-edit-mode');
    
    if (editToggle && viewMode && editMode) {
        editToggle.addEventListener('click', function() {
            // Toggle main card edit mode
            const isEditMode = editMode.style.display !== 'none';
            
            if (isEditMode) {
                // Switch back to view mode for all sections
                editMode.style.display = 'none';
                viewMode.style.display = 'block';
                
                if (basicInfoEditMode && basicInfoViewMode) {
                    basicInfoEditMode.style.display = 'none';
                    basicInfoViewMode.style.display = 'block';
                }
                
                if (readingProgressEditMode && readingProgressViewMode) {
                    readingProgressEditMode.style.display = 'none';
                    readingProgressViewMode.style.display = 'block';
                }
                
                if (personalNotesEditMode && personalNotesViewMode) {
                    personalNotesEditMode.style.display = 'none';
                    personalNotesViewMode.style.display = 'block';
                }
                
                if (customMetadataEditMode && customMetadataViewMode) {
                    customMetadataEditMode.style.display = 'none';
                    customMetadataViewMode.style.display = 'block';
                }
                
                editToggle.innerHTML = '<i class="bi bi-pencil" id="edit-icon"></i>';
                editToggle.title = 'Edit Book Details';
            } else {
                // Switch to edit mode for all sections
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                
                if (basicInfoEditMode && basicInfoViewMode) {
                    basicInfoViewMode.style.display = 'none';
                    basicInfoEditMode.style.display = 'block';
                }
                
                if (readingProgressEditMode && readingProgressViewMode) {
                    readingProgressViewMode.style.display = 'none';
                    readingProgressEditMode.style.display = 'block';
                }
                
                if (personalNotesEditMode && personalNotesViewMode) {
                    personalNotesViewMode.style.display = 'none';
                    personalNotesEditMode.style.display = 'block';
                }
                
                if (customMetadataEditMode && customMetadataViewMode) {
                    customMetadataViewMode.style.display = 'none';
                    customMetadataEditMode.style.display = 'block';
                }
                
                editToggle.innerHTML = '<i class="bi bi-check" id="edit-icon"></i>';
                editToggle.title = 'Exit Edit Mode';
            }
        });
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                // Cancel edit mode for all sections
                editMode.style.display = 'none';
                viewMode.style.display = 'block';
                
                if (basicInfoEditMode && basicInfoViewMode) {
                    basicInfoEditMode.style.display = 'none';
                    basicInfoViewMode.style.display = 'block';
                }
                
                if (readingProgressEditMode && readingProgressViewMode) {
                    readingProgressEditMode.style.display = 'none';
                    readingProgressViewMode.style.display = 'block';
                }
                
                if (personalNotesEditMode && personalNotesViewMode) {
                    personalNotesEditMode.style.display = 'none';
                    personalNotesViewMode.style.display = 'block';
                }
                
                if (customMetadataEditMode && customMetadataViewMode) {
                    customMetadataEditMode.style.display = 'none';
                    customMetadataViewMode.style.display = 'block';
                }
                
                editToggle.innerHTML = '<i class="bi bi-pencil" id="edit-icon"></i>';
                editToggle.title = 'Edit Book Details';
            });
        }
    }
    
    // Location loading for edit mode in main card
    const editLocationSelect = document.getElementById('edit_location_id');
    if (editLocationSelect) {
        const currentEditLocationName = editLocationSelect.getAttribute('data-current-location');
        
        fetch('/locations/api/user_locations')
            .then(response => response.json())
            .then(locations => {
                editLocationSelect.innerHTML = '<option value="">Select location...</option>';
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    if (location.is_default) {
                        option.textContent += ' (Default)';
                    }
                    if (location.name === currentEditLocationName) {
                        option.selected = true;
                    }
                    editLocationSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading edit locations:', error);
                editLocationSelect.innerHTML = '<option value="">Error loading locations</option>';
            });
    }
    
    // Dynamic ownership/borrowing fields for Basic Information
    const ownershipSelect = document.getElementById('ownership_status');
    const borrowedSection = document.getElementById('borrowed-section');
    const loanedSection = document.getElementById('loaned-section');
    
    function updateVisibility() {
        if (ownershipSelect && borrowedSection && loanedSection) {
            const ownership = ownershipSelect.value;
            borrowedSection.style.display = ownership === 'borrowed' ? 'block' : 'none';
            loanedSection.style.display = ownership === 'loaned' ? 'block' : 'none';
        }
    }
    
    if (ownershipSelect) {
        ownershipSelect.addEventListener('change', updateVisibility);
        updateVisibility(); // Initial setup
    }
    
    // Accordion behavior - ensure only one is open at a time
    const accordionItems = document.querySelectorAll('#bookAccordion .accordion-collapse');
    accordionItems.forEach(item => {
        item.addEventListener('show.bs.collapse', function() {
            accordionItems.forEach(otherItem => {
                if (otherItem !== item && otherItem.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(otherItem, {toggle: false});
                    bsCollapse.hide();
                }
            });
        });
    });
    
    // Cover editing functionality
    initializeCoverEditing();
    
    // Initialize autocomplete functionality
    initializeAutocomplete();
});

function initializeCoverEditing() {
    const coverUrlInput = document.getElementById('cover_url');
    const previewUrlBtn = document.getElementById('preview-url-btn');
    const coverFileInput = document.getElementById('cover_file');
    const fetchCoverBtn = document.getElementById('fetch-cover-btn');
    const fetchCoverTitleBtn = document.getElementById('fetch-cover-title-btn');
    const newCoverPreview = document.getElementById('new-cover-preview');
    const removeCoverCheck = document.getElementById('remove_cover');
    
    // Preview URL functionality
    if (previewUrlBtn && coverUrlInput) {
        previewUrlBtn.addEventListener('click', function() {
            const url = coverUrlInput.value.trim();
            if (url) {
                previewCoverImage(url);
            } else {
                alert('Please enter a URL first.');
            }
        });
        
        // Auto-preview when URL changes
        coverUrlInput.addEventListener('blur', function() {
            const url = this.value.trim();
            if (url) {
                previewCoverImage(url);
            }
        });
    }
    
    // File upload preview
    if (coverFileInput) {
        coverFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (coverUrlInput) coverUrlInput.value = '';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewCoverImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Fetch cover by ISBN
    if (fetchCoverBtn) {
        fetchCoverBtn.addEventListener('click', function() {
            const isbn = '{{ book.isbn13 or book.isbn10 or book.isbn or "" }}';
            if (isbn) {
                fetchCoverFromAPI(isbn, 'isbn');
            } else {
                alert('No ISBN available for this book.');
            }
        });
    }
    
    // Fetch cover by title and author
    if (fetchCoverTitleBtn) {
        fetchCoverTitleBtn.addEventListener('click', function() {
            const title = '{{ book.title|e }}';
            const author = '{{ (book.authors[0].name if book.authors else "")|e }}';
            if (title && author) {
                fetchCoverFromAPI(`${title} ${author}`, 'title');
            } else {
                alert('Missing title or author information.');
            }
        });
    }
    
    // Remove cover checkbox
    if (removeCoverCheck) {
        removeCoverCheck.addEventListener('change', function() {
            if (this.checked) {
                if (coverUrlInput) coverUrlInput.value = '';
                if (coverFileInput) coverFileInput.value = '';
                showPlaceholderPreview();
            }
        });
    }
}

function previewCoverImage(src) {
    const preview = document.getElementById('new-cover-preview');
    if (preview && src) {
        preview.innerHTML = `<img src="${src}" alt="Cover Preview" class="img-fluid rounded shadow-sm" style="max-height: 200px;">`;
        
        // Uncheck remove cover if checked
        const removeCoverCheck = document.getElementById('remove_cover');
        if (removeCoverCheck) removeCoverCheck.checked = false;
    }
}

function showPlaceholderPreview() {
    const preview = document.getElementById('new-cover-preview');
    if (preview) {
        preview.innerHTML = `
            <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                 style="height: 200px; width: 133px; margin: 0 auto;">
                <i class="bi bi-book text-muted" style="font-size: 3rem;"></i>
            </div>
        `;
    }
}

function fetchCoverFromAPI(query, type) {
    const fetchBtn = type === 'isbn' ? document.getElementById('fetch-cover-btn') : document.getElementById('fetch-cover-title-btn');
    const originalText = fetchBtn.innerHTML;
    
    // Show loading state
    fetchBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Searching...';
    fetchBtn.disabled = true;
    
    const endpoint = type === 'isbn' ? 
        `/api/search/book/${query}` :
        `/api/search/cover?q=${encodeURIComponent(query)}`;
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            if (data.cover) {
                // Update URL input and preview
                const coverUrlInput = document.getElementById('cover_url');
                if (coverUrlInput) {
                    coverUrlInput.value = data.cover;
                }
                previewCoverImage(data.cover);
                
                // Clear file input
                const coverFileInput = document.getElementById('cover_file');
                if (coverFileInput) coverFileInput.value = '';
            } else {
                alert('No cover image found for this book.');
            }
        })
        .catch(error => {
            console.error('Error fetching cover:', error);
            alert('Failed to fetch cover image. Please try again.');
        })
        .finally(() => {
            // Restore button state
            fetchBtn.innerHTML = originalText;
            fetchBtn.disabled = false;
        });
}

// Autocomplete functionality
function initializeAutocomplete() {
    const authorsInput = document.getElementById('edit-authors');
    const categoriesInput = document.getElementById('edit-categories');
    
    if (authorsInput) {
        setupAutocomplete(authorsInput, 'authors', searchAuthors, addAuthorToInput);
    }
    
    if (categoriesInput) {
        setupAutocomplete(categoriesInput, 'categories', searchCategories, addCategoryToInput);
    }
}

function setupAutocomplete(input, type, searchFn, addFn) {
    const dropdown = document.getElementById(`${type}-dropdown`);
    let debounceTimer;
    
    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const value = input.value;
            const currentInput = value.split(',').pop().trim();
            
            if (currentInput.length >= 2) {
                searchFn(currentInput, dropdown, addFn, input);
            } else {
                dropdown.style.display = 'none';
            }
        }, 300);
    });
    
    input.addEventListener('focus', function() {
        const value = input.value;
        const currentInput = value.split(',').pop().trim();
        if (currentInput.length >= 2) {
            searchFn(currentInput, dropdown, addFn, input);
        }
    });
    
    input.addEventListener('blur', function() {
        setTimeout(() => dropdown.style.display = 'none', 200);
    });
}

function searchAuthors(query, dropdown, addFn, input) {
    fetch(`/api/authors/search?q=${encodeURIComponent(query)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            showDropdown(dropdown, data.authors || [], query, addFn, input, 'Author');
        })
        .catch(error => {
            console.error('Error searching authors:', error);
            dropdown.style.display = 'none';
        });
}

function searchCategories(query, dropdown, addFn, input) {
    fetch(`/api/categories/search?q=${encodeURIComponent(query)}&limit=10`)
        .then(response => response.json())
        .then(data => {
            showDropdown(dropdown, data.categories || [], query, addFn, input, 'Genre');
        })
        .catch(error => {
            console.error('Error searching categories:', error);
            dropdown.style.display = 'none';
        });
}

function showDropdown(dropdown, items, query, addFn, input, type) {
    if (items.length === 0 && !query) {
        dropdown.style.display = 'none';
        return;
    }
    
    dropdown.innerHTML = '';
    
    // Add existing items
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'autocomplete-item';
        div.textContent = item.name;
        div.addEventListener('click', () => addFn(item.name, input));
        dropdown.appendChild(div);
    });
    
    // Add "Add New" option
    if (query) {
        const addNewDiv = document.createElement('div');
        addNewDiv.className = 'autocomplete-item add-new';
        addNewDiv.innerHTML = `<i class="bi bi-plus-circle me-1"></i>Add New ${type}: "${query}"`;
        addNewDiv.addEventListener('click', () => addFn(query, input));
        dropdown.appendChild(addNewDiv);
    }
    
    dropdown.style.display = 'block';
}

function addAuthorToInput(authorName, input) {
    const currentValue = input.value;
    const values = currentValue.split(',').map(v => v.trim()).filter(v => v);
    const lastValue = values.pop() || '';
    
    // Don't add if already exists
    if (values.includes(authorName)) {
        input.focus();
        return;
    }
    
    values.push(authorName);
    input.value = values.join(', ');
    input.focus();
    
    // Hide dropdown
    const dropdown = document.getElementById('authors-dropdown');
    if (dropdown) dropdown.style.display = 'none';
}

function addCategoryToInput(categoryName, input) {
    const currentValue = input.value;
    const values = currentValue.split(',').map(v => v.trim()).filter(v => v);
    const lastValue = values.pop() || '';
    
    // Don't add if already exists
    if (values.includes(categoryName)) {
        input.focus();
        return;
    }
    
    values.push(categoryName);
    input.value = values.join(', ');
    input.focus();
    
    // Hide dropdown
    const dropdown = document.getElementById('categories-dropdown');
    if (dropdown) dropdown.style.display = 'none';
}

// Custom Fields Search Functionality
function setupCustomFieldsSearch() {
    const searchInput = document.getElementById('customFieldSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const fieldItems = document.querySelectorAll('.custom-field-item');
            
            fieldItems.forEach(item => {
                const fieldName = item.querySelector('.fw-medium').textContent.toLowerCase();
                const fieldValueElement = item.querySelector('.custom-field-value');
                const fieldValue = fieldValueElement ? fieldValueElement.textContent.toLowerCase() : '';
                
                if (fieldName.includes(searchTerm) || fieldValue.includes(searchTerm)) {
                    item.closest('.col-md-6').style.display = '';
                } else {
                    item.closest('.col-md-6').style.display = 'none';
                }
            });
        });
    }
}

// Description Toggle Functionality
function setupDescriptionToggle() {
    const expandBtns = document.querySelectorAll('.expand-description');
    expandBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const shortDesc = document.getElementById('description-short');
            const fullDesc = document.getElementById('description-full');
            
            if (fullDesc.style.display === 'none' || !fullDesc.style.display) {
                fullDesc.style.display = 'block';
                shortDesc.style.display = 'none';
            } else {
                fullDesc.style.display = 'none';
                shortDesc.style.display = 'block';
            }
        });
    });
}

// Initialize all functions when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupCustomFieldsSearch();
    setupDescriptionToggle();
});
</script>

<style>
/* Autocomplete dropdown styles */
.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-item.add-new {
    background-color: #e3f2fd;
    color: #1976d2;
    font-weight: 500;
}

.autocomplete-item.add-new:hover {
    background-color: #bbdefb;
}

/* Dark mode support for autocomplete */
[data-theme="dark"] .autocomplete-dropdown {
    background: #2d2d2d;
    border-color: #404040;
    color: #e0e0e0;
}

[data-theme="dark"] .autocomplete-item {
    border-bottom-color: #404040;
}

[data-theme="dark"] .autocomplete-item:hover {
    background-color: #404040;
}

[data-theme="dark"] .autocomplete-item.add-new {
    background-color: #1a237e;
    color: #82b1ff;
}

[data-theme="dark"] .autocomplete-item.add-new:hover {
    background-color: #283593;
}

/* Dark mode enhancements for View Book */
[data-theme="dark"] .text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] small.text-muted {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .form-text {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .form-text a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .card {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-header {
    background-color: rgba(60, 60, 60, 0.8) !important;
    border-bottom-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .card-body {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .bg-light {
    background-color: rgba(50, 50, 50, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] #borrowed-section,
[data-theme="dark"] #loaned-section {
    background-color: rgba(50, 50, 50, 0.8) !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-label {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .fw-medium {
    color: #e0e0e0 !important;
}

[data-theme="dark"] .accordion-item {
    background-color: rgba(40, 40, 40, 0.8) !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .accordion-body {
    background-color: rgba(40, 40, 40, 0.8) !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .badge.bg-light {
    background-color: rgba(60, 60, 60, 0.8) !important;
    color: #e0e0e0 !important;
    border-color: #404040 !important;
}

[data-theme="dark"] .breadcrumb-item a {
    color: #6ea8fe !important;
}

[data-theme="dark"] .breadcrumb-item.active {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .h6.text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted p {
    color: #b0b0b0 !important;
}

[data-theme="dark"] .text-center.text-muted .small {
    color: #c0c0c0 !important;
}

[data-theme="dark"] .text-primary {
    color: #6ea8fe !important;
}

/* Additional form styling for dark mode */
[data-theme="dark"] .form-control,
[data-theme="dark"] .form-select {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .form-control:focus,
[data-theme="dark"] .form-select:focus {
    background-color: #2d2d2d !important;
    border-color: #86b7fe !important;
    color: #e0e0e0 !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Action Icon Buttons Styling */
.action-icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-icon-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.action-icon-btn.btn-outline-primary:hover {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.action-icon-btn.btn-outline-danger:hover {
    background-color: var(--bs-danger);
    border-color: var(--bs-danger);
    color: white;
}

/* Dark mode for action icons */
[data-theme="dark"] .action-icon-btn {
    background-color: rgba(40, 40, 40, 0.9);
    border-color: #555;
    color: #e0e0e0;
}

[data-theme="dark"] .action-icon-btn.btn-outline-primary {
    border-color: var(--bs-primary);
    color: var(--bs-primary);
}

[data-theme="dark"] .action-icon-btn.btn-outline-danger {
    border-color: var(--bs-danger);
    color: var(--bs-danger);
}

[data-theme="dark"] .action-icon-btn:hover {
    background-color: rgba(60, 60, 60, 0.9);
}

/* Cover Edit Button Styling */
.cover-edit-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 10;
}

.cover-edit-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    background-color: var(--bs-secondary);
    border-color: var(--bs-secondary);
    color: white;
}

/* Dark mode for cover edit button */
[data-theme="dark"] .cover-edit-btn {
    background-color: rgba(40, 40, 40, 0.9);
    border-color: #555;
    color: #e0e0e0;
}

[data-theme="dark"] .cover-edit-btn:hover {
    background-color: var(--bs-secondary);
    border-color: var(--bs-secondary);
    color: white;
}

/* Cover preview styling */
.cover-preview-container {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Modal enhancements */
[data-theme="dark"] .modal-content {
    background-color: #2d2d2d;
    border-color: #404040;
    color: #e0e0e0;
}

[data-theme="dark"] .modal-header {
    border-bottom-color: #404040;
}

[data-theme="dark"] .modal-footer {
    border-top-color: #404040;
}

[data-theme="dark"] .form-check-label {
    color: #e0e0e0;
}

[data-theme="dark"] .form-check-label.text-danger {
    color: #ff6b6b !important;
}

.card {
    border: none;
    transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
}

.accordion-item {
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.375rem;
}

.accordion-button {
    font-weight: 500;
    border-radius: 0.375rem;
}

.accordion-button:not(.collapsed) {
    color: white;
    background-color: var(--bs-primary);
    box-shadow: none;
}

.accordion-button.bg-primary:not(.collapsed) {
    background-color: var(--bs-primary) !important;
}

.accordion-button.bg-success:not(.collapsed) {
    background-color: var(--bs-success) !important;
}

.accordion-button.bg-info:not(.collapsed) {
    background-color: var(--bs-info) !important;
}

.accordion-button.bg-warning:not(.collapsed) {
    background-color: var(--bs-warning) !important;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.accordion-body {
    padding: 1.25rem;
}

.form-label {
    color: #495057;
    font-size: 0.9rem;
}

.badge {
    font-size: 0.75rem;
}

.btn {
    font-size: 0.9rem;
}

#borrowed-section, #loaned-section {
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
}

.breadcrumb-item a {
    text-decoration: none;
}

/* Smooth transitions for accordion */
.accordion-collapse {
    transition: height 0.35s ease;
}

/* Better spacing between accordion items */
.accordion-item:not(:last-child) {
    margin-bottom: 0.5rem;
}

/* Genre badge hover effects */
.badge.bg-light:hover {
    background-color: #e2e6ea !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.badge.bg-secondary:hover {
    background-color: #5a6268 !important;
    transform: translateY(-1px);
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Dark mode support */
[data-theme="dark"] .badge.bg-light:hover {
    background-color: #495057 !important;
    color: white !important;
}

/* Position relative for autocomplete containers */
.position-relative {
    position: relative;
}
</style>

<!-- Debug Panel (Admin Only) -->
{% include 'components/debug_panel.html' %}

{% endblock %}
