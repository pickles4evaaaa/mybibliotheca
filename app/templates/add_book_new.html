{% extends "base.html" %}
{% block title %}Add Book - MyBibliotheca{% endblock %}
{% block content %}
<style>
  /* Info icon styling */
  .info-icon {
    color: #6c757d;
    font-size: 0.9rem;
    margin-left: 0.5rem;
    cursor: help;
    position: relative;
  }

  .info-icon:hover {
    color: #495057;
  }

  /* Tooltip styling */
  .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #555;
    color: white;
    text-align: left;
    border-radius: 6px;
    padding: 8px 10px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.8rem;
    line-height: 1.3;
  }

  .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
  }

  .info-icon:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }

  /* File upload styling */
  .upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: #f8f9fa;
    min-height: 80px;
  }

  .upload-area:hover {
    border-color: #adb5bd;
    background-color: #e9ecef;
  }

  .upload-area.dragover {
    border-color: #0d6efd;
    background-color: #e7f3ff;
    transform: scale(1.02);
  }

  /* Dark mode improvements */
  [data-theme="dark"] .form-control {
    background-color: #495057;
    border-color: #6c757d;
    color: #fff;
  }

  [data-theme="dark"] .form-control:focus {
    background-color: #495057;
    border-color: #86b7fe;
    color: #fff;
  }

  [data-theme="dark"] .form-label {
    color: #f8f9fa;
  }

  [data-theme="dark"] .upload-area {
    background-color: #495057;
    border-color: #6c757d;
    color: #f8f9fa;
  }

  [data-theme="dark"] .upload-area:hover {
    border-color: #adb5bd;
    background-color: #6c757d;
  }

  [data-theme="dark"] .tooltip-text {
    background-color: #212529;
    color: #f8f9fa;
  }

  [data-theme="dark"] .tooltip-text::after {
    border-color: #212529 transparent transparent transparent;
  }

  [data-theme="dark"] .info-icon {
    color: #adb5bd;
  }

  [data-theme="dark"] .info-icon:hover {
    color: #f8f9fa;
  }
</style>

<div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-plus-circle me-2"></i>Add Books
        </h1>
        <div>
            <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back to Library
            </a>
        </div>
    </div>

    <!-- Main Accordion Container -->
    <div class="accordion" id="addBookAccordion">
        
        <!-- Quick Add Options Accordion Item -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#quickAddCollapse" aria-expanded="true" aria-controls="quickAddCollapse">
                    <i class="bi bi-search me-2"></i>Quick Add Options
                </button>
            </h2>
            <div id="quickAddCollapse" class="accordion-collapse collapse show" 
                 data-bs-parent="#addBookAccordion">
                <div class="accordion-body">
        
        <!-- ISBN Lookup and File Upload in Same Row -->
        <div class="row">
            <!-- ISBN Lookup -->
            <div class="col-md-6 mb-3">
                <label for="isbn-lookup" class="form-label fw-bold">
                    ISBN Lookup
                    <span class="info-icon">
                        <i class="bi bi-info-circle"></i>
                        <span class="tooltip-text">
                            Enter a 10-digit ISBN-10 or 13-digit ISBN-13 to automatically fetch book details from online databases.
                        </span>
                    </span>
                </label>
                <div class="input-group">
                    <input type="text" class="form-control" id="isbn-lookup" placeholder="Enter ISBN-10 or ISBN-13">
                    <button type="button" class="btn btn-primary" onclick="fetchBookFromISBN()">
                        <i class="bi bi-search me-1"></i>Fetch Book
                    </button>
                </div>
            </div>
            
            <!-- File Upload -->
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">
                    File Upload
                    <span class="info-icon">
                        <i class="bi bi-info-circle"></i>
                        <span class="tooltip-text">
                            Supported formats:<br>
                            • Images (JPG, PNG, JPEG) - Extract ISBN from cover<br>
                            • CSV Files - Bulk import multiple books
                        </span>
                    </span>
                </label>
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <i class="bi bi-cloud-upload fs-3 text-muted mb-2"></i>
                    <div class="text-muted">
                        <small><strong>Drop files here or click to browse</strong></small>
                    </div>
                </div>                            <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.csv" style="display: none;" onchange="handleFileUpload(this)">
                <div id="file-preview" class="mt-2"></div>
            </div>
        </div>
    </div>

        
        <!-- Book Details Accordion Item -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#bookDetailsCollapse" aria-expanded="false" aria-controls="bookDetailsCollapse">
                    <i class="bi bi-book me-2"></i>Book Details
                </button>
            </h2>
            <div id="bookDetailsCollapse" class="accordion-collapse collapse" 
                 aria-labelledby="bookDetailsHeader">
                <div class="accordion-body">
                    <form method="post" action="{{ url_for('main.add_book_manual') }}" id="book-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Nested Accordion for Book Details -->
                        <div class="accordion" id="bookDetailsAccordion">
                
                <!-- Basic Information -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseBasic" aria-expanded="false" aria-controls="collapseBasic">
                            <i class="bi bi-info-circle me-2"></i>Basic Information
                        </button>
                    </h2>
                    <div id="collapseBasic" class="accordion-collapse collapse" 
                         data-bs-parent="#bookDetailsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="title" class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="title" name="title" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="isbn" class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="isbn" name="isbn" placeholder="10 or 13 digit ISBN">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="author" class="form-label">Primary Author</label>
                                    <input type="text" class="form-control" id="author" name="author" placeholder="Primary author name">
                                </div>
                                <div class="col-md-6">
                                    <label for="additional_authors" class="form-label">Additional Authors</label>
                                    <input type="text" class="form-control" id="additional_authors" name="additional_authors" placeholder="Co-authors (comma-separated)">
                                </div>
                            </div>
                            
                            <!-- Book Lookup Section -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-search me-2"></i>Look Up Book Details
                                            </h6>
                                            <p class="card-text small text-muted mb-3">
                                                Search for book information using title and/or author to auto-fill the form
                                            </p>
                                            <button type="button" class="btn btn-outline-primary" id="lookup-book-btn" onclick="searchForBook()">
                                                <i class="bi bi-search me-2"></i>Search for Book
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results Display -->
                            <div class="row mb-3" id="search-results-container" style="display: none;">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-list-ul me-2"></i>Search Results
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="search-results-list">
                                                <!-- Results will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="subtitle" class="form-label">Subtitle</label>
                                    <input type="text" class="form-control" id="subtitle" name="subtitle" placeholder="Book subtitle (if any)">
                                </div>
                                <div class="col-md-6">
                                    <label for="publisher" class="form-label">Publisher</label>
                                    <input type="text" class="form-control" id="publisher" name="publisher" placeholder="Publisher name">
                                </div>
                            </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="page_count" class="form-label">Page Count</label>
                                    <input type="number" class="form-control" id="page_count" name="page_count" min="1" placeholder="Number of pages">
                                </div>
                                <div class="col-md-3">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language" name="language">
                                        <option value="en" selected>English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="it">Italian</option>
                                        <option value="pt">Portuguese</option>
                                        <option value="ru">Russian</option>
                                        <option value="ja">Japanese</option>
                                        <option value="ko">Korean</option>
                                        <option value="zh">Chinese</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="cover_url" class="form-label">Cover URL</label>
                                    <input type="url" class="form-control" id="cover_url" name="cover_url" placeholder="https://...">
                                </div>
                                <div class="col-md-6">
                                    <label for="published_date" class="form-label">Published Date</label>
                                    <input type="date" class="form-control" id="published_date" name="published_date">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="description" class="form-label">Description/Summary</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="Book description or summary..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Series & Categories -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseSeriesCategories" aria-expanded="false" aria-controls="collapseSeriesCategories">
                            <i class="bi bi-collection me-2"></i>Series & Categories
                        </button>
                    </h2>
                    <div id="collapseSeriesCategories" class="accordion-collapse collapse" 
                         data-bs-parent="#bookDetailsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                                                        <label for="series" class="form-label">Series</label>
                                                                        <div class="position-relative" id="series-autocomplete-wrapper">
                                                                            <input type="text" class="form-control" id="series" name="series" autocomplete="off" placeholder="Series name (type to search or create)">
                                                                            <div id="series-autocomplete-dropdown" class="list-group shadow-sm" style="position:absolute; top:100%; left:0; right:0; z-index:40; max-height:260px; overflow-y:auto; display:none;"></div>
                                                                            <input type="hidden" name="series_id" id="series_id">
                                                                        </div>
                                                                        <div class="form-text" id="series-help">Start typing to search existing series. Press Enter to create a new one if no match.</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="series_volume" class="form-label">Volume</label>
                                    <input type="text" class="form-control" id="series_volume" name="series_volume" placeholder="e.g., Book 1, Vol. 2">
                                </div>
                                <div class="col-md-3">
                                    <label for="series_order" class="form-label">Series Order</label>
                                    <input type="number" class="form-control" id="series_order" name="series_order" min="1" placeholder="1">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="genres" class="form-label">Genres/Categories</label>
                                    <input type="text" class="form-control" id="genres" name="manual_categories" placeholder="e.g., Science Fiction, Fantasy, Mystery">
                                    <div class="form-text">Enter one or more genres separated by commas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Personal Library Details -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapsePersonalDetails" aria-expanded="false" aria-controls="collapsePersonalDetails">
                            <i class="bi bi-person-check me-2"></i>Personal Library Details
                        </button>
                    </h2>
                    <div id="collapsePersonalDetails" class="accordion-collapse collapse" 
                         data-bs-parent="#bookDetailsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="reading_status" class="form-label">Reading Status</label>
                                    <select class="form-select" id="reading_status" name="reading_status">
                                        <option value="" selected>Not set</option>
                                        <option value="plan_to_read">Plan to Read</option>
                                        <option value="reading">Currently Reading</option>
                                        <option value="read">Read</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="did_not_finish">Did Not Finish</option>
                                        <option value="library_only">Library Only (No Reading Intent)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="ownership_status" class="form-label">Ownership Status</label>
                                    <select class="form-select" id="ownership_status" name="ownership_status">
                                        <option value="owned" selected>Owned</option>
                                        <option value="borrowed">Borrowed</option>
                                        <option value="loaned">Loaned Out</option>
                                        <option value="wishlist">Wishlist</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="media_type" class="form-label">Media Type</label>
                                    <select class="form-select" id="media_type" name="media_type">
                                        <option value="physical" selected>Physical Book</option>
                                        <option value="ebook">E-book</option>
                                        <option value="audiobook">Audiobook</option>
                                        <option value="kindle">Kindle</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="location_id" class="form-label">Location</label>
                                    <select class="form-select" id="location_id" name="location_id">
                                        <option value="">Select a location...</option>
                                        <!-- Locations will be populated by JavaScript or server-side -->
                                    </select>
                                    <div class="form-text">
                                        <a href="{{ url_for('locations.manage_locations') }}" target="_blank" class="text-decoration-none">
                                            <i class="bi bi-gear me-1"></i>Manage Locations
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="user_rating" class="form-label">My Rating</label>
                                    <select class="form-select" id="user_rating" name="user_rating">
                                        <option value="">No Rating</option>
                                        <option value="1">⭐ 1 Star</option>
                                        <option value="2">⭐⭐ 2 Stars</option>
                                        <option value="3">⭐⭐⭐ 3 Stars</option>
                                        <option value="4">⭐⭐⭐⭐ 4 Stars</option>
                                        <option value="5">⭐⭐⭐⭐⭐ 5 Stars</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="start_date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date">
                                </div>
                                <div class="col-md-6">
                                    <label for="finish_date" class="form-label">Finish Date</label>
                                    <input type="date" class="form-control" id="finish_date" name="finish_date">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="personal_notes" class="form-label">Personal Notes</label>
                                    <textarea class="form-control" id="personal_notes" name="personal_notes" rows="3" placeholder="Your personal thoughts about this book..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="user_tags" class="form-label">Personal Tags</label>
                                    <input type="text" class="form-control" id="user_tags" name="user_tags" placeholder="e.g., favorite, quick-read, beach-book">
                                    <div class="form-text">Enter tags separated by commas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Fields -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseCustomFields" aria-expanded="false" aria-controls="collapseCustomFields">
                            <i class="bi bi-tags me-2"></i>Custom Fields
                        </button>
                    </h2>
                    <div id="collapseCustomFields" class="accordion-collapse collapse" 
                         data-bs-parent="#bookDetailsAccordion">
                        <div class="accordion-body">
                            {% if personal_fields or global_fields %}
                                <!-- Personal Custom Fields -->
                                {% if personal_fields %}
                                    <h6 class="small mb-3">Your Custom Fields:</h6>
                                    <div class="row">
                                        {% for field in personal_fields %}
                                            <div class="col-md-6 mb-3">
                                                <label for="custom_field_{{ field.name }}" class="form-label">
                                                    {{ field.display_name }}
                                                    {% if field.description %}
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="{{ field.description }}"></i>
                                                    {% endif %}
                                                </label>
                                                {% if field.field_type.value == 'select' %}
                                                    <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                        <option value="">Select...</option>
                                                        {% for option in field.select_options %}
                                                            <option value="{{ option }}">{{ option }}</option>
                                                        {% endfor %}
                                                    </select>
                                                {% elif field.field_type.value == 'boolean' %}
                                                    <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                        <option value="">Select...</option>
                                                        <option value="true">Yes</option>
                                                        <option value="false">No</option>
                                                    </select>
                                                {% elif field.field_type.value == 'number' %}
                                                    <input type="number" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" step="any">
                                                {% elif field.field_type.value == 'date' %}
                                                    <input type="date" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                {% elif field.field_type.value == 'textarea' %}
                                                    <textarea class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" rows="2"></textarea>
                                                {% else %}
                                                    <input type="text" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <!-- Global Custom Fields -->
                                {% if global_fields %}
                                    <h6 class="small mb-3 mt-4">Community Custom Fields:</h6>
                                    <div class="row">
                                        {% for field in global_fields %}
                                            <div class="col-md-6 mb-3">
                                                <label for="custom_field_{{ field.name }}" class="form-label">
                                                    {{ field.display_name }}
                                                    {% if field.description %}
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="{{ field.description }}"></i>
                                                    {% endif %}
                                                </label>
                                                {% if field.field_type.value == 'select' %}
                                                    <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                        <option value="">Select...</option>
                                                        {% for option in field.select_options %}
                                                            <option value="{{ option }}">{{ option }}</option>
                                                        {% endfor %}
                                                    </select>
                                                {% elif field.field_type.value == 'boolean' %}
                                                    <select class="form-select" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                        <option value="">Select...</option>
                                                        <option value="true">Yes</option>
                                                        <option value="false">No</option>
                                                    </select>
                                                {% elif field.field_type.value == 'number' %}
                                                    <input type="number" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" step="any">
                                                {% elif field.field_type.value == 'date' %}
                                                    <input type="date" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                {% elif field.field_type.value == 'textarea' %}
                                                    <textarea class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}" rows="2"></textarea>
                                                {% else %}
                                                    <input type="text" class="form-control" id="custom_field_{{ field.name }}" name="custom_field_{{ field.name }}">
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="bi bi-info-circle text-muted me-2"></i>
                                    <span class="text-muted">No custom fields available.</span>
                                </div>
                                <div class="text-center">
                                    <a href="{{ url_for('auth.settings') }}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-gear me-1"></i>Create Custom Fields
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="mt-4 text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle me-1"></i>Add Book to Library
                </button>
            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
    </div> <!-- End main accordion -->
</div>

<script>
// Global helper functions for safe DOM access
function safeGetValue(elementId) {
    const element = document.getElementById(elementId);
    return element ? element.value : null;
}

function safeSetValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element && value !== null && value !== undefined) {
        element.value = value;
        // Trigger change event to ensure any listeners are notified
        element.dispatchEvent(new Event('change', { bubbles: true }));
        return true;
    }
    return false;
}

// File upload handling
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const filePreview = document.getElementById('file-preview');

// Handle drag and drop events
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileUpload(fileInput);
    }
});

// Handle file upload
function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    const fileName = file.name;
    const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
    const fileType = file.type;
    
    // Detect file type and show appropriate preview
    let fileTypeDisplay = '';
    let processingMessage = '';
    
    if (fileType.startsWith('image/')) {
        fileTypeDisplay = '📷 Image';
        processingMessage = 'Choose processing method below';
    } else if (fileName.toLowerCase().endsWith('.csv')) {
        fileTypeDisplay = '📁 CSV';
        processingMessage = 'Will import multiple books from CSV';
    } else if (fileName.toLowerCase().endsWith('.db')) {
        fileTypeDisplay = '🗄️ Database';
        processingMessage = 'Will migrate books from SQLite database';
    } else {
        fileTypeDisplay = '📄 Unknown';
        processingMessage = 'File type not supported';
    }
    
    // Show file preview with processing options for images
    if (fileType.startsWith('image/')) {
        filePreview.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <strong>${fileTypeDisplay}</strong>
                    </div>
                    <div class="flex-grow-1">
                        <div><strong>${fileName}</strong></div>
                        <div class="small text-muted">${fileSize} MB • ${processingMessage}</div>
                        <div class="mt-2">
                            <select class="form-select form-select-sm" id="processing-method" style="width: auto; display: inline-block;">
                                <option value="ocr">Extract ISBN (OCR)</option>
                                {% if ai_config and ai_config.get('AI_BOOK_EXTRACTION_ENABLED') == 'true' %}
                                <option value="ai">Process with AI</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="processFile()">
                            <i class="bi bi-play-circle me-1"></i>Process
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearFile()">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Show file preview for non-image files
        filePreview.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <strong>${fileTypeDisplay}</strong>
                    </div>
                    <div class="flex-grow-1">
                        <div><strong>${fileName}</strong></div>
                        <div class="small text-muted">${fileSize} MB • ${processingMessage}</div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="processFile()">
                            <i class="bi bi-play-circle me-1"></i>Process
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearFile()">
                            <i class="bi bi-x-circle me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
}

// Process uploaded file
function processFile() {
    const file = fileInput.files[0];
    if (!file) return;
    
    const fileName = file.name;
    const fileType = file.type;
    
    // Create form data
    const formData = new FormData();
    
    // Use the correct field name based on file type
    if (fileName.toLowerCase().endsWith('.csv')) {
        formData.append('csv_file', file);
    } else if (fileName.toLowerCase().endsWith('.db')) {
        formData.append('db_file', file);
    } else {
        formData.append('image', file);
    }
    
    formData.append('csrf_token', '{{ csrf_token() }}');
    
    // Determine processing endpoint based on file type and method
    let endpoint = '';
    let processingMessage = 'Processing';
    
    if (fileType.startsWith('image/')) {
        // Check processing method for images
        const processingMethodElement = document.getElementById('processing-method');
        const processingMethod = processingMethodElement ? processingMethodElement.value : 'ocr';
        
        console.log('Processing method element:', processingMethodElement);
        console.log('Processing method value:', processingMethod);
        
        if (processingMethod === 'ai') {
            endpoint = '{{ url_for("book.add_book_from_image_ai") }}';
            processingMessage = 'Processing with AI';
        } else {
            endpoint = '{{ url_for("main.add_book_from_image") }}';
            processingMessage = 'Extracting ISBN';
        }
    } else if (fileName.toLowerCase().endsWith('.csv')) {
        endpoint = '{{ url_for("import.simple_upload") }}';
        processingMessage = 'Importing CSV';
    } else if (fileName.toLowerCase().endsWith('.db')) {
        endpoint = '{{ url_for("main.migrate_sqlite") }}';
        processingMessage = 'Migrating database';
    } else {
        alert('Unsupported file type. Please select an image, CSV, or SQLite database file.');
        return;
    }
    
    // Show processing message
    filePreview.innerHTML = `
        <div class="alert alert-info">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <strong>${processingMessage} ${fileName}...</strong>
            </div>
        </div>
    `;
    
    // Submit file for processing
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Handle successful response
            if (fileName.toLowerCase().endsWith('.csv')) {
                // For CSV files, handle JSON response from simple-upload
                return response.json();
            } else if (fileName.toLowerCase().endsWith('.db')) {
                // For DB files, redirect to the response URL (mapping page)
                window.location.href = response.url;
            } else {
                // For images, handle the ISBN extraction result
                return response.json();
            }
        } else {
            throw new Error('Processing failed');
        }
    })
    .then(data => {
        if (data && data.isbn) {
            // Traditional OCR processing - just ISBN
            safeSetValue('isbn-lookup', data.isbn);
            fetchBookFromISBN();
        } else if (data && (data.title || data.authors)) {
            // AI processing - full book data
            populateFormWithAIData(data);
            showMessage('success', 'AI processed book details successfully! Please review and add any additional information.');
        } else if (data && data.task_id) {
            // For CSV imports, redirect to progress page
            window.location.href = `/import/import-books/progress/${data.task_id}`;
        } else if (data && data.message) {
            // Show message from server
            showMessage('info', data.message);
        }
    })
    .catch(error => {
        console.error('Error processing file:', error);
        filePreview.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Error processing file:</strong> ${error.message}
            </div>
        `;
    });
}

// Clear uploaded file
function clearFile() {
    fileInput.value = '';
    filePreview.innerHTML = '';
}

// Populate form with AI-extracted data
function populateFormWithAIData(data) {
    // Helper function to safely set element value
    function safeSetValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element && value !== null && value !== undefined) {
            element.value = value;
            return true;
        }
        return false;
    }
    // Normalize various date formats to YYYY-MM-DD for date input
    function normalizeDateToInput(val) {
        if (!val) return '';
        const s = String(val).trim();
        if (/^\d{4}$/.test(s)) return `${s}-01-01`;
        if (/^\d{4}-\d{2}$/.test(s)) return `${s}-01`;
        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (m) {
            const [_, mm, dd, yyyy] = m;
            return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
        }
        return s;
    }
    
    // Basic information
    if (data.title) safeSetValue('title', data.title);
    if (data.subtitle) safeSetValue('subtitle', data.subtitle);
    if (data.isbn) safeSetValue('isbn', data.isbn);
    // Also populate explicit isbn10/13 fields when possible
    const rawIsbn = data.isbn || data.isbn13 || data.isbn_13 || data.isbn10 || data.isbn_10;
    if (data.isbn13 || data.isbn_13) safeSetValue('isbn13', data.isbn13 || data.isbn_13);
    if (data.isbn10 || data.isbn_10) safeSetValue('isbn10', data.isbn10 || data.isbn_10);
    if (!data.isbn13 && !data.isbn_13 && rawIsbn && String(rawIsbn).replace(/[^0-9Xx]/g,'').length === 13) {
        safeSetValue('isbn13', rawIsbn);
    }
    if (!data.isbn10 && !data.isbn_10 && rawIsbn && String(rawIsbn).replace(/[^0-9Xx]/g,'').length === 10) {
        safeSetValue('isbn10', rawIsbn);
    }
    
    // Handle authors
    if (data.authors) {
        if (typeof data.authors === 'string') {
            // Split author string by semicolon or comma
            const authorList = data.authors.split(/[;,]/).map(a => a.trim()).filter(a => a);
            if (authorList.length > 0) {
                safeSetValue('author', authorList[0]);
                if (authorList.length > 1) {
                    safeSetValue('additional_authors', authorList.slice(1).join(', '));
                }
            }
        }
    }
    
    // Publication details
    if (data.publisher) safeSetValue('publisher', data.publisher);
    if (data.publication_year) {
        // Convert year to full date format for the date input
        safeSetValue('published_date', `${data.publication_year}-01-01`);
    }
    if (data.published_date) {
        safeSetValue('published_date', normalizeDateToInput(data.published_date));
    }
    if (data.page_count) safeSetValue('page_count', data.page_count);
    if (data.language) safeSetValue('language', data.language);
    if (data.edition) safeSetValue('edition', data.edition);
    
    // Additional information
    if (data.genre) safeSetValue('genre', data.genre);
    if (data.series) safeSetValue('series', data.series);
    
    // Handle contributors - convert to format that works with existing author fields
    if (data.contributors) {
        let contributors;
        
        // Handle both string and array formats
        if (typeof data.contributors === 'string') {
            try {
                // Try to parse as JSON string first
                contributors = JSON.parse(data.contributors.replace(/'/g, '"'));
            } catch (e) {
                // If that fails, treat it as a simple string
                console.log('Contributors as string:', data.contributors);
                return; // Skip processing if we can't parse it
            }
        } else if (Array.isArray(data.contributors)) {
            contributors = data.contributors;
        } else {
            return; // Skip if not a recognizable format
        }
        
        if (Array.isArray(contributors)) {
            const authors = contributors.filter(c => c.role && c.role.toLowerCase().includes('author')).map(c => c.name);
            const editors = contributors.filter(c => c.role && c.role.toLowerCase().includes('editor')).map(c => c.name);
            const others = contributors.filter(c => c.role && !c.role.toLowerCase().includes('author') && !c.role.toLowerCase().includes('editor')).map(c => `${c.name} (${c.role})`);
            
            // Set primary author if we found authors and don't already have one
            if (authors.length > 0 && !safeGetValue('author')) {
                safeSetValue('author', authors[0]);
                if (authors.length > 1) {
                    const additionalAuthors = authors.slice(1).concat(editors).concat(others).join(', ');
                    if (additionalAuthors) {
                        safeSetValue('additional_authors', additionalAuthors);
                    }
                }
            } else if (authors.length > 0) {
                // We already have an author, so put all contributors in additional authors
                const allContributors = authors.concat(editors).concat(others).join(', ');
                const existingAdditional = safeGetValue('additional_authors');
                const combinedAdditional = existingAdditional ? `${existingAdditional}, ${allContributors}` : allContributors;
                safeSetValue('additional_authors', combinedAdditional);
            }
        }
    }
    
    // Auto-expand accordions to show the filled data
    expandBookDetails();
}

// Fetch book data from ISBN
function fetchBookFromISBN() {
    const isbn = safeGetValue('isbn-lookup');
    if (!isbn || !isbn.trim()) {
        alert('Please enter an ISBN');
        return;
    }
    
    // Show loading state
    const button = document.querySelector('button[onclick="fetchBookFromISBN()"]');
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Fetching...';
    button.disabled = true;
    
    // Fetch book data
    fetch(`{{ url_for('main.fetch_book', isbn='') }}${isbn}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Book not found');
            }
            return response.json();
        })
        .then(data => {
            // Check if we got actual book data
            if (data && (data.title || data.author || data.authors)) {
                // Populate form fields
                if (data.title) safeSetValue('title', data.title);
                if (data.isbn || isbn) safeSetValue('isbn', data.isbn || isbn);
                
                // Handle authors intelligently
                if (data.authors_list && Array.isArray(data.authors_list) && data.authors_list.length > 0) {
                    // Use the structured authors list if available
                    safeSetValue('author', data.authors_list[0]); // Primary author
                    if (data.authors_list.length > 1) {
                        const additionalAuthors = data.authors_list.slice(1).join(', ');
                        safeSetValue('additional_authors', additionalAuthors);
                    }
                } else if (data.author) {
                    // Handle comma-separated author string
                    const authorList = data.author.split(',').map(a => a.trim()).filter(a => a);
                    if (authorList.length > 0) {
                        safeSetValue('author', authorList[0]); // Primary author
                        if (authorList.length > 1) {
                            const additionalAuthors = authorList.slice(1).join(', ');
                            safeSetValue('additional_authors', additionalAuthors);
                        }
                    }
                }
                
                if (data.subtitle) safeSetValue('subtitle', data.subtitle);
                if (data.publisher) safeSetValue('publisher', data.publisher);
                if (data.page_count) safeSetValue('page_count', data.page_count);
                if (data.language) safeSetValue('language', data.language);
                if (data.cover_url || data.cover) safeSetValue('cover_url', data.cover_url || data.cover);
                if (data.published_date) {
                    const s = String(data.published_date).trim();
                    let norm = s;
                    if (/^\d{4}$/.test(s)) norm = `${s}-01-01`;
                    else if (/^\d{4}-\d{2}$/.test(s)) norm = `${s}-01`;
                    else {
                        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                        if (m) norm = `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
                    }
                    safeSetValue('published_date', norm);
                }
                if (data.description) safeSetValue('description', data.description);
                
                // Auto-expand accordions to show the filled data
                expandBookDetails();
                
                // Show success message
                showMessage('success', 'Book details fetched successfully! Please review and add any additional information.');
                
            } else {
                showMessage('warning', 'Book found but no details available. Please fill in the information manually.');
            }
        })
        .catch(error => {
            console.error('Error fetching book:', error);
            showMessage('error', 'Book not found. Please check the ISBN and try again, or fill in the details manually.');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalContent;
            button.disabled = false;
        });
}

// Helper function to show messages
function showMessage(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 'alert-danger';
    const icon = type === 'success' ? 'bi-check-circle' : 
                 type === 'warning' ? 'bi-exclamation-triangle' : 'bi-x-circle';
    
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
    alert.innerHTML = `
        <i class="bi ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const cardBody = document.querySelector('.card-body');
    if (cardBody) {
        cardBody.appendChild(alert);
    } else {
        // Fallback - append to the main container or body
        const container = document.querySelector('.container') || document.querySelector('main') || document.body;
        if (container) {
            container.appendChild(alert);
        }
    }
    
    // Auto-remove message after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (alert.parentNode) alert.remove();
        }, 5000);
    }
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Accordion State Tracking
function trackAccordionState(accordionType, isExpanding) {
    // Simple tracking - no complex behavior needed since accordions are independent
    console.log(`Accordion ${accordionType} ${isExpanding ? 'expanding' : 'collapsing'}`);
}

// Auto-expand Book Details when ISBN lookup succeeds
function expandBookDetails() {
    const bookDetailsElement = document.getElementById('bookDetailsCollapse');
    const basicInfoElement = document.getElementById('collapseBasic');
    
    if (bookDetailsElement && !bookDetailsElement.classList.contains('show')) {
        const bookDetailsButton = document.querySelector('[data-bs-target="#bookDetailsCollapse"]');
        if (bookDetailsButton) {
            bookDetailsButton.click();
        }
        
        // Also expand Basic Information within Book Details
        setTimeout(() => {
            if (basicInfoElement && !basicInfoElement.classList.contains('show')) {
                const basicInfoButton = document.querySelector('[data-bs-target="#collapseBasic"]');
                if (basicInfoButton) {
                    basicInfoButton.click();
                }
            }
        }, 300);
    } else if (basicInfoElement && !basicInfoElement.classList.contains('show')) {
        // If Book Details is already open, just expand Basic Information
        const basicInfoButton = document.querySelector('[data-bs-target="#collapseBasic"]');
        if (basicInfoButton) {
            basicInfoButton.click();
        }
    }
}

// Load locations on page load
document.addEventListener('DOMContentLoaded', function() {
  loadUserLocations();
  
  // Initialize tooltips for custom field descriptions
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

function loadUserLocations() {
  const locationSelect = document.getElementById('manual-location');
  if (locationSelect) {
    // Add default option
    locationSelect.innerHTML = '<option value="">Select a location...</option>';
    
    // Fetch user locations from the API
    fetch('{{ url_for("locations.api_user_locations") }}')
      .then(response => response.json())
      .then(locations => {
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = location.name;
          if (location.is_default) {
            option.selected = true;
          }
          locationSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error loading locations:', error);
        // Add a fallback option
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading locations';
        locationSelect.appendChild(option);
      });
  }
}

function fetchBookData() {
  const isbn = safeGetValue('manual-isbn').trim();
  if (!isbn) {
    alert('Please enter an ISBN first.');
    return;
  }
  
  // Show loading state
  const fetchBtn = document.querySelector('button[onclick="fetchBookData()"]');
  const originalText = fetchBtn.innerHTML;
  fetchBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Fetching...';
  fetchBtn.disabled = true;
  
  fetch(`{{ url_for('main.fetch_book', isbn='') }}${isbn}`)
    .then(response => response.json())
    .then(data => {
      if (data.title) safeSetValue('title', data.title);
      if (data.author) safeSetValue('author', data.author);
      if (data.subtitle) safeSetValue('subtitle', data.subtitle);
      if (data.cover) safeSetValue('cover_url', data.cover);
      if (data.publisher) safeSetValue('publisher', data.publisher);
      if (data.page_count) safeSetValue('page_count', data.page_count);
      if (data.published_date) safeSetValue('published_date', data.published_date);
      if (data.language) safeSetValue('language', data.language);
      if (data.description) safeSetValue('description', data.description);
      
      // Handle categories/genres
      if (data.categories) {
        const categories = Array.isArray(data.categories) ? data.categories.join(', ') : data.categories;
        safeSetValue('genres', categories);
      }
      
      // Handle series information
      if (data.series) {
        safeSetValue('series', data.series);
        if (data.series_volume) safeSetValue('series_volume', data.series_volume);
        if (data.series_order) safeSetValue('series_order', data.series_order);
      }
    })
    .catch(error => {
      console.error('Error fetching book data:', error);
      alert('Failed to fetch book data. Please try again.');
    })
    .finally(() => {
      // Restore button state
      fetchBtn.innerHTML = originalText;
      fetchBtn.disabled = false;
    });
}

// Handle reading status changes to automatically update dates
document.getElementById('reading_status').addEventListener('change', function() {
  const status = this.value;
  const startDateField = document.getElementById('start_date');
  const finishDateField = document.getElementById('finish_date');
  const today = new Date().toISOString().split('T')[0];
  
  if (status === 'reading' && !startDateField.value) {
    startDateField.value = today;
  } else if (status === 'read' && !finishDateField.value) {
    finishDateField.value = today;
    if (!startDateField.value) {
      // Set start date to a week ago if not specified
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      startDateField.value = weekAgo.toISOString().split('T')[0];
    }
  }
});

// Handle image file selection for image import tab
document.getElementById('image-file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const submitBtn = document.querySelector('#image-import form button[type="submit"]');
  
  if (file) {
    // Update the label to show selected file
    const label = document.querySelector('#image-import .border-dashed p');
    label.innerHTML = `<i class="bi bi-file-earmark-image me-1"></i>Selected: ${file.name}`;
    
    // Enable the submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-magic me-1"></i>Extract Book Information';
    
    // Validate file size (10MB max)
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    if (file.size > maxSize) {
      alert('File size must be less than 10MB');
      e.target.value = '';
      submitBtn.disabled = true;
      label.innerHTML = 'Drag and drop an image here, or click to browse';
      return;
    }
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/heic'];
    if (!allowedTypes.includes(file.type)) {
      alert('Please select a valid image file (JPG, PNG, or HEIC)');
      e.target.value = '';
      submitBtn.disabled = true;
      label.innerHTML = 'Drag and drop an image here, or click to browse';
      return;
    }
  } else {
    // Reset if no file selected
    submitBtn.disabled = true;
    document.querySelector('#image-import .border-dashed p').innerHTML = 'Drag and drop an image here, or click to browse';
  }
});

// Handle drag and drop for image upload
const imageDropZone = document.querySelector('#image-import .border-dashed');
const imageFileInput = document.getElementById('image-file');

imageDropZone.addEventListener('dragover', function(e) {
  e.preventDefault();
  imageDropZone.style.backgroundColor = '#f8f9fa';
  imageDropZone.style.borderColor = '#007bff';
});

imageDropZone.addEventListener('dragleave', function(e) {
  e.preventDefault();
  imageDropZone.style.backgroundColor = '';
  imageDropZone.style.borderColor = '#dee2e6';
});

imageDropZone.addEventListener('drop', function(e) {
  e.preventDefault();
  imageDropZone.style.backgroundColor = '';
  imageDropZone.style.borderColor = '#dee2e6';
  
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    imageFileInput.files = files;
    // Trigger the change event
    const event = new Event('change', { bubbles: true });
    imageFileInput.dispatchEvent(event);
  }
});

// Book search functionality
function searchForBook() {
  const title = safeGetValue('title');
  const author = safeGetValue('author');
  
  if (!title && !author) {
    alert('Please enter at least a title or author to search for books.');
    return;
  }
  
  const button = document.getElementById('lookup-book-btn');
  const originalContent = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="bi bi-search me-2"></i>Searching...';
  
  // Build search query
  const searchData = {};
  if (title) searchData.title = title;
  if (author) searchData.author = author;
  
  fetch('{{ url_for("book.search_book_details") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify(searchData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.results && data.results.length > 0) {
      displaySearchResults(data.results);
    } else {
      showMessage('warning', data.message || 'No books found matching your search criteria.');
    }
  })
  .catch(error => {
    console.error('Search error:', error);
    showMessage('error', 'An error occurred while searching for books. Please try again.');
  })
  .finally(() => {
    button.disabled = false;
    button.innerHTML = originalContent;
  });
}

function displaySearchResults(results) {
  const container = document.getElementById('search-results-container');
  const resultsList = document.getElementById('search-results-list');
  
  // Clear previous results
  resultsList.innerHTML = '';
  
  // Create result items
  results.forEach((book, index) => {
    const resultItem = document.createElement('div');
    resultItem.className = 'border rounded p-3 mb-3 search-result-item';
    resultItem.style.cursor = 'pointer';
    
    const title = book.title || 'Unknown Title';
    const authors = book.authors || book.author || 'Unknown Author';
    const publisher = book.publisher || '';
    const publishedDate = book.published_date || book.publication_year || '';
    const isbn = book.isbn || '';
    const description = book.description || '';
    
    resultItem.innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <h6 class="mb-1">${title}</h6>
          <p class="mb-1 text-muted">by ${authors}</p>
          ${publisher ? `<small class="text-muted">Published by ${publisher}${publishedDate ? ` (${publishedDate})` : ''}</small>` : ''}
          ${isbn ? `<br><small class="text-muted">ISBN: ${isbn}</small>` : ''}
          ${description ? `<p class="mt-2 small">${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>` : ''}
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-primary btn-sm" onclick="selectBookResult(${index})">
            <i class="bi bi-check2 me-1"></i>Use This Book
          </button>
        </div>
      </div>
    `;
    
    // Add hover effect
    resultItem.addEventListener('mouseenter', () => {
      resultItem.style.backgroundColor = '#f8f9fa';
    });
    resultItem.addEventListener('mouseleave', () => {
      resultItem.style.backgroundColor = '';
    });
    
    resultsList.appendChild(resultItem);
  });
  
  // Store results globally for selection
  window.searchResults = results;
  
  // Show the results container
  container.style.display = 'block';
  container.scrollIntoView({ behavior: 'smooth' });
}

function selectBookResult(index) {
  const book = window.searchResults[index];
  if (!book) return;
  
  // Populate form with selected book data
  if (book.title) safeSetValue('title', book.title);
  if (book.isbn) safeSetValue('isbn', book.isbn);
  if (book.subtitle) safeSetValue('subtitle', book.subtitle);
  if (book.publisher) safeSetValue('publisher', book.publisher);
  if (book.page_count) safeSetValue('page_count', book.page_count);
  if (book.language) safeSetValue('language', book.language);
  
  // Enhanced cover URL handling
  const coverUrl = book.cover_url || book.cover;
  if (coverUrl) {
    safeSetValue('cover_url', coverUrl);
  }
  
  if (book.published_date || book.publication_year) safeSetValue('published_date', book.published_date || book.publication_year);
  if (book.description) safeSetValue('description', book.description);
  
  // Handle authors
  if (book.authors_list && Array.isArray(book.authors_list)) {
    if (book.authors_list.length > 0) {
      safeSetValue('author', book.authors_list[0]);
      if (book.authors_list.length > 1) {
        safeSetValue('additional_authors', book.authors_list.slice(1).join(', '));
      }
    }
  } else if (book.authors || book.author) {
    const authorString = book.authors || book.author;
    const authorList = authorString.split(',').map(a => a.trim()).filter(a => a);
    if (authorList.length > 0) {
      safeSetValue('author', authorList[0]);
      if (authorList.length > 1) {
        safeSetValue('additional_authors', authorList.slice(1).join(', '));
      }
    }
  }
  
  // Hide search results
  document.getElementById('search-results-container').style.display = 'none';
  
  // Auto-expand accordions to show the filled data
  expandBookDetails();
  
  // Show success message
  showMessage('success', `Book details loaded: "${book.title}"`);
}
</script>

<div class="text-center mt-4">
  <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Library
  </a>
</div>
</div>

{% endblock %}
{% block extra_scripts %}
<script>
(function(){
    const input = document.getElementById('series');
    if(!input) return;
    const hiddenId = document.getElementById('series_id');
    const dropdown = document.getElementById('series-autocomplete-dropdown');
    let lastQuery = '';
    let pending = null;
    let results = [];
    let activeIndex = -1;
    const csrf = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    function clearDropdown(){
        dropdown.innerHTML='';
        dropdown.style.display='none';
        results=[]; activeIndex=-1;
    }
    function render(items, query){
        if(!items.length && query){
            dropdown.innerHTML = `<button type="button" class="list-group-item list-group-item-action" data-create="1">Create new series \"${escapeHtml(query)}\"</button>`;
            dropdown.style.display='block';
            return;
        }
        dropdown.innerHTML = items.map((it,i)=>`
            <button type="button" class="list-group-item list-group-item-action${i===activeIndex?' active':''}" data-id="${it.id}" data-name="${escapeHtml(it.name)}">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${escapeHtml(it.name)}</span>
                    <small class="text-muted">${it.book_count||0} book${(it.book_count||0)===1?'':'s'}</small>
                </div>
            </button>`).join('');
        if(query && !items.find(i=>i.name.toLowerCase()===query.toLowerCase())){
            dropdown.innerHTML += `<button type="button" class="list-group-item list-group-item-action" data-create="1">Create new series \"${escapeHtml(query)}\"</button>`;
        }
        dropdown.style.display = dropdown.innerHTML.trim()? 'block':'none';
    }
    function escapeHtml(str){return (str||'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));}
    function debouncedFetch(q){
        if(pending) clearTimeout(pending);
        if(!q){ clearDropdown(); hiddenId.value=''; return; }
        pending = setTimeout(()=>{
            fetch(`/series/search?q=${encodeURIComponent(q)}`,{headers:{'Accept':'application/json'}})
                .then(r=>r.ok?r.json():Promise.reject())
                .then(data=>{ console.debug('[SeriesSearch][Add]',data); if(data && data.success){ results = data.results||[]; } else if(Array.isArray(data)){ results=data; } else { results=[]; } activeIndex=-1; render(results,q); })
                .catch(err=>{ console.warn('[SeriesSearch][Add] failed',err); results=[]; render(results,q); });
        },200);
    }
    input.addEventListener('input', e=>{ const q = e.target.value.trim(); hiddenId.value=''; lastQuery=q; debouncedFetch(q); });
    input.addEventListener('keydown', e=>{
        if(dropdown.style.display==='none') return; 
        if(e.key==='ArrowDown'){ e.preventDefault(); activeIndex = (activeIndex+1) % Math.max(results.length,1); render(results,lastQuery); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); activeIndex = activeIndex<=0? results.length-1 : activeIndex-1; render(results,lastQuery); }
        else if(e.key==='Enter'){ 
            if(activeIndex>=0 && results[activeIndex]){ selectResult(results[activeIndex]); e.preventDefault(); }
            else if(!results.length || !results.find(r=>r.name.toLowerCase()===lastQuery.toLowerCase())){ e.preventDefault(); createSeries(lastQuery); }
        } else if(e.key==='Escape'){ clearDropdown(); }
    });
    dropdown.addEventListener('click', e=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.create==='1'){ createSeries(lastQuery); return; }
        const id = btn.dataset.id; const name = btn.dataset.name; if(id && name){ hiddenId.value=id; input.value=name; clearDropdown(); }
    });
    document.addEventListener('click', e=>{ if(!dropdown.contains(e.target) && e.target!==input) clearDropdown(); });

    function selectResult(r){ hiddenId.value = r.id; input.value = r.name; clearDropdown(); }
    function createSeries(name){ if(!name) return; 
        fetch('/series/create',{method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json','X-CSRFToken':csrf}, body: JSON.stringify({name})})
            .then(r=>r.ok?r.json():Promise.reject())
            .then(data=>{ if(data.success && data.series){ hiddenId.value = data.series.id; input.value = data.series.name; clearDropdown(); }})
            .catch(()=>{});
    }
})();
</script>
{% endblock %}
