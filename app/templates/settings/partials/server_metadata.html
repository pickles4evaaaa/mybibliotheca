{% set books = metadata_settings.get('books', {}) %}
{% set people = metadata_settings.get('people', {}) %}
{% set book_provider_map = {
  'google_books_id': ['google'],
  'openlibrary_id': ['openlibrary'],
  'average_rating': ['google'],
  'rating_count': ['google'],
  'language': ['google'],
  'cover_url': ['google','openlibrary'],
  'isbn10': ['google','openlibrary'],
  'isbn13': ['google','openlibrary'],
  'title': ['google','openlibrary'],
  'subtitle': ['google','openlibrary'],
  'authors': ['google','openlibrary'],
  'publisher': ['google','openlibrary'],
  'published_date': ['google','openlibrary'],
  'page_count': ['google','openlibrary'],
  'description': ['google','openlibrary'],
  'categories': ['google','openlibrary'],
  'series': ['google','openlibrary']
} %}
{% set people_provider_map = {
  'name': ['openlibrary'],
  'birth_date': ['openlibrary'],
  'death_date': ['openlibrary'],
  'birth_year': ['openlibrary'],
  'death_year': ['openlibrary'],
  'birth_place': ['openlibrary'],
  'bio': ['openlibrary'],
  'website': ['openlibrary'],
  'image_url': ['openlibrary'],
  'openlibrary_id': ['openlibrary']
} %}
<div class="p-3" id="metadata-root" data-csrf-token="{{ csrf_token() }}">
  <h5 class="mb-3">Metadata Provider Policies</h5>
  <p class="text-muted small">Configure which external provider supplies each field. Modes: <strong>Google</strong>, <strong>OpenLibrary</strong>, <strong>Both</strong> (choose default), or <strong>None</strong> (skip).</p>
  <ul class="nav nav-tabs" id="metadataTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books-pane" type="button" role="tab">Books</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="people-tab" data-bs-toggle="tab" data-bs-target="#people-pane" type="button" role="tab">People</button>
    </li>
  </ul>
  <div class="tab-content border border-top-0 p-3 bg-light rounded-bottom" id="metadataTabsContent">
    <div class="tab-pane fade show active" id="books-pane" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-sm align-middle table-striped">
          <thead><tr><th>Field</th><th style="width:160px">Mode</th><th style="width:170px">Default (if Both)</th></tr></thead>
          <tbody>
          {% for field, cfg in books.items()|sort %}
            <tr data-entity="books" data-field="{{ field }}">
              <td class="fw-semibold">{{ field }}</td>
              <td>
                {% set providers = book_provider_map.get(field, ['google','openlibrary']) %}
                {% set allowed_modes = [] %}
                {% if providers|length == 1 %}
                  {% set _ = allowed_modes.append(providers[0]) %}
                {% else %}
                  {% set _ = allowed_modes.append('google') %}
                  {% set _ = allowed_modes.append('openlibrary') %}
                  {% set _ = allowed_modes.append('both') %}
                {% endif %}
                {% set _ = allowed_modes.append('none') %}
                <select class="form-select form-select-sm mode-select" data-providers="{{ providers|join(',') }}">
                  {% for mode in allowed_modes %}
                    <option value="{{ mode }}" {% if cfg.mode == mode %}selected{% endif %}>{{ mode.title() }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                {% if book_provider_map.get(field, ['google','openlibrary'])|length > 1 %}
                  <div class="default-wrapper {% if cfg.mode != 'both' %}d-none{% endif %}">
                    <select class="form-select form-select-sm default-select" {% if cfg.mode != 'both' %}disabled{% endif %}>
                      <option value="google" {% if cfg.default=='google' %}selected{% endif %}>Google</option>
                      <option value="openlibrary" {% if cfg.default=='openlibrary' %}selected{% endif %}>OpenLibrary</option>
                    </select>
                  </div>
                  <div class="default-placeholder text-muted small {% if cfg.mode == 'both' %}d-none{% endif %}">—</div>
                {% else %}
                  <div class="text-muted small">—</div>
                  <select class="d-none default-select"><option value="google">Google</option></select>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="tab-pane fade" id="people-pane" role="tabpanel">
      <div class="table-responsive">
        {% set people_has_multi = false %}
        {% for providers in people_provider_map.values() %}
          {% if providers|length > 1 %}{% set people_has_multi = true %}{% endif %}
        {% endfor %}
        <table class="table table-sm align-middle table-striped">
          <thead>
            <tr>
              <th>Field</th>
              <th style="width:160px">Mode</th>
              {% if people_has_multi %}<th style="width:170px">Default</th>{% endif %}
            </tr>
          </thead>
          <tbody>
          {% for field, cfg in people.items()|sort %}
            <tr data-entity="people" data-field="{{ field }}">
              <td class="fw-semibold">{{ field }}</td>
              <td>
                {% set providers = people_provider_map.get(field, ['openlibrary']) %}
                {% set allowed_modes = [] %}
                {% if providers|length == 1 %}
                  {% set _ = allowed_modes.append(providers[0]) %}
                {% else %}
                  {% set _ = allowed_modes.append('openlibrary') %}
                  {% set _ = allowed_modes.append('both') %}
                {% endif %}
                {% set _ = allowed_modes.append('none') %}
                <select class="form-select form-select-sm mode-select" data-providers="{{ providers|join(',') }}">
                  {% for mode in allowed_modes %}
                    <option value="{{ mode }}" {% if cfg.mode == mode %}selected{% endif %}>{{ mode.title() }}</option>
                  {% endfor %}
                </select>
              </td>
              {% if people_has_multi %}
              <td>
                <select class="form-select form-select-sm default-select" {% if cfg.mode != 'both' %}disabled{% endif %}>
                  <option value="google" {% if cfg.default=='google' %}selected{% endif %}>Google</option>
                  <option value="openlibrary" {% if cfg.default=='openlibrary' %}selected{% endif %}>OpenLibrary</option>
                </select>
              </td>
              {% endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="d-flex flex-column flex-md-row gap-2 mt-3 align-items-md-center" id="metadata-settings-actions">
    <div class="d-flex gap-2 flex-wrap">
      <button id="revert-metadata-settings" class="btn btn-sm btn-outline-secondary" title="Reload settings without saving" onclick="window.dispatchEvent(new Event('reload-settings-panel'))">Revert</button>
    </div>
    <div class="settings-save-bar mt-0 ms-md-auto">
      <div id="metadata-save-status" class="settings-status"></div>
      <button id="save-metadata-settings" class="btn btn-sm btn-primary" title="Save metadata provider settings"
        onclick="(function(btn){var root=btn.closest('.p-3');if(!root)return;var status=root.querySelector('#metadata-save-status');function ser(){var d={books:{},people:{}};root.querySelectorAll('tr[data-entity]').forEach(function(tr){var e=tr.dataset.entity,f=tr.dataset.field,m=tr.querySelector('.mode-select').value;var prov=(tr.querySelector('.mode-select').dataset.providers||'').split(',').filter(Boolean);if(prov.length===1&&m==='both')m=prov[0];if(prov.length===1&&prov.indexOf(m)===-1&&m!=='none')m=prov[0];var defSel=tr.querySelector('.default-select');var ent={mode:m};if(m==='both'&&defSel)ent.default=defSel.value;d[e][f]=ent;});return d;}var base=location.pathname.indexOf('/auth/settings/partial/server/')>-1?location.pathname:'/auth/settings/partial/server/metadata';var url=base.indexOf('/metadata')>-1?base:base;var payload=ser();status.textContent='Saving...';var headers={'Content-Type':'application/json'};var csrf=root.getAttribute('data-csrf-token');if(csrf)headers['X-CSRFToken']=csrf;fetch(url,{method:'POST',headers:headers,credentials:'same-origin',body:JSON.stringify(payload)}).then(function(r){var sc=r.status;return r.text().then(function(t){var j;try{j=JSON.parse(t);}catch(e){j={ok:false,error:'parse_failed',raw:t.slice(0,120)};}j._status=sc;return j;});}).then(function(j){console.debug('Metadata save response',j);if(j.ok){status.textContent='Saved.';setTimeout(function(){window.dispatchEvent(new Event('reload-settings-panel'));},400);}else{status.textContent='Save failed ('+(j.error||'unknown')+' status='+j._status+')';}}).catch(function(err){console.error('Metadata save error',err);status.textContent='Error.';});})(this);"><i class="bi bi-save me-1"></i>Save Changes</button>
    </div>
  </div>
</div>
