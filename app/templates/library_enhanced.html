{% extends "base.html" %}

{% block title %}My Library - MyBibliotheca{% endblock %}
{% block content %}
<style>
  :root {
    --primary-brown: #8B4513;
    --light-brown: #D2B48C;
    --cream: #F5F5DC;
    --warm-white: #FEFEFE;
    --gold: #DAA520;
    --shadow: rgba(0,0,0,0.1);
    --hover-shadow: rgba(0,0,0,0.2);
    --text-color: #333;
    --header-text: white;
    --card-bg: white;
    --card-text: #333;
  }

  /* Dark mode overrides */
  [data-theme="dark"] {
    --primary-brown: #6b5b73;
    --light-brown: #8a7ca8;
    --cream: #2d2d2d;
    --warm-white: #1e1e1e;
    --gold: #f0c674;
    --shadow: rgba(0,0,0,0.3);
    --hover-shadow: rgba(0,0,0,0.5);
    --text-color: #e0e0e0;
    --header-text: #f0c674;
    --card-bg: #2d2d2d;
    --card-text: #e0e0e0;
  }

  .book-cover-wrapper {
    height: 240px;
    overflow: hidden;
    position: relative;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
  }

  .book-cover {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.2s ease;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .book-card:hover .book-cover {
    transform: scale(1.05);
  }

  .book-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
  }

  .book-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  }

  /* Dark mode card styling */
  [data-theme="dark"] .book-card {
    background-color: var(--card-bg) !important;
    color: var(--card-text) !important;
    border-color: #404040 !important;
  }

  [data-theme="dark"] .book-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
  }

  [data-theme="dark"] .card-body {
    background-color: var(--card-bg) !important;
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .book-title {
    color: var(--card-text) !important;
  }

  [data-theme="dark"] .text-muted {
    color: #b0b0b0 !important;
  }

  [data-theme="dark"] .stats-row .card {
    background-color: var(--card-bg) !important;
    border-color: #404040 !important;
  }

  [data-theme="dark"] .stats-row .card-body {
    color: var(--card-text) !important;
  }

  /* Dark mode filter button overrides */
  [data-theme="dark"] .filter-btn.btn-warning {
    background-color: rgba(255, 193, 7, 0.2) !important;
    border-color: #ffc107 !important;
    color: #ffd43b !important;
  }

  [data-theme="dark"] .filter-btn.btn-success {
    background-color: rgba(25, 135, 84, 0.2) !important;
    border-color: #198754 !important;
    color: #51cf66 !important;
  }

  [data-theme="dark"] .filter-btn.btn-info {
    background-color: rgba(13, 202, 240, 0.2) !important;
    border-color: #0dcaf0 !important;
    color: #74c0fc !important;
  }

  [data-theme="dark"] .filter-btn.btn-primary {
    background-color: rgba(13, 110, 253, 0.2) !important;
    border-color: #0d6efd !important;
    color: #6ea8fe !important;
  }

  [data-theme="dark"] .filter-btn.btn-secondary {
    background-color: rgba(108, 117, 125, 0.2) !important;
    border-color: #6c757d !important;
    color: #adb5bd !important;
  }

  [data-theme="dark"] .filter-btn.btn-dark {
    background-color: rgba(33, 37, 41, 0.3) !important;
    border-color: #495057 !important;
    color: #f8f9fa !important;
  }

  /* Dark mode text and header styling */
  [data-theme="dark"] .h4 {
    color: var(--text-color) !important;
  }

  [data-theme="dark"] small.text-muted {
    color: #b0b0b0 !important;
  }

  /* Ensure filter button text colors work in dark mode */
  [data-theme="dark"] .text-warning {
    color: #ffd43b !important;
  }

  [data-theme="dark"] .text-success {
    color: #51cf66 !important;
  }

  [data-theme="dark"] .text-info {
    color: #74c0fc !important;
  }

  [data-theme="dark"] .text-primary {
    color: #6ea8fe !important;
  }

  [data-theme="dark"] .text-secondary {
    color: #adb5bd !important;
  }

  .book-title {
    font-size: 0.9rem;
    line-height: 1.2;
    height: 2.4em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .filter-btn {
    transition: all 0.2s ease;
    border: 2px solid;
  }

  .filter-btn:hover {
    transform: translateY(-2px);
  }

  /* Fix for selected filter button - very light styling */
  .filter-btn.btn-warning {
    background-color: rgba(255, 193, 7, 0.1) !important; /* Very light yellow */
    border-color: #ffc107 !important;
    color: #856404 !important; /* Dark yellow text */
  }

  .filter-btn.btn-success {
    background-color: rgba(25, 135, 84, 0.1) !important; /* Very light green */
    border-color: #198754 !important;
    color: #0a3622 !important; /* Dark green text */
  }

  .filter-btn.btn-info {
    background-color: rgba(13, 202, 240, 0.1) !important; /* Very light blue */
    border-color: #0dcaf0 !important;
    color: #055160 !important; /* Dark blue text */
  }

  .filter-btn.btn-primary {
    background-color: rgba(13, 110, 253, 0.1) !important; /* Very light blue */
    border-color: #0d6efd !important;
    color: #052c65 !important; /* Dark blue text */
  }

  .filter-btn.btn-secondary {
    background-color: rgba(108, 117, 125, 0.1) !important; /* Very light gray */
    border-color: #6c757d !important;
    color: #373a3c !important; /* Dark gray text */
  }

  .filter-btn.btn-dark {
    background-color: rgba(33, 37, 41, 0.1) !important; /* Very light dark */
    border-color: #212529 !important;
    color: #212529 !important; /* Dark text */
  }

  .book-checkbox {
    transform: scale(1.2);
  }

  /* Searchable dropdown styles */
  .dropdown-search-wrapper {
    position: relative;
  }

  .dropdown-search-btn {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .dropdown-search-btn .selected-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    text-align: left;
  }

  .dropdown-search-menu {
    max-height: 300px;
    overflow-y: auto;
    min-width: 100%;
  }

  .dropdown-search-input {
    border: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
    margin: 0;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
  }

  .dropdown-search-input:focus {
    box-shadow: none;
    border-bottom-color: #0d6efd;
  }

  .dropdown-item {
    cursor: pointer;
    padding: 0.5rem 1rem;
  }

  .dropdown-item:hover {
    background-color: #f8f9fa;
  }

  .dropdown-item.active {
    background-color: #0d6efd;
    color: white;
  }

  /* Dark mode dropdown styles */
  [data-theme="dark"] .dropdown-search-input {
    background-color: #2d2d2d;
    color: #e0e0e0;
    border-bottom-color: #6c757d;
  }

  [data-theme="dark"] .dropdown-search-input:focus {
    border-bottom-color: #0d6efd;
  }

  [data-theme="dark"] .dropdown-menu {
    background-color: #2d2d2d;
    border-color: #6c757d;
  }

  [data-theme="dark"] .dropdown-item {
    color: #e0e0e0;
  }

  [data-theme="dark"] .dropdown-item:hover {
    background-color: #404040;
  }

  [data-theme="dark"] .dropdown-item.active {
    background-color: #0d6efd;
    color: white;
  }
</style>

<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-book me-2"></i>My Library
        </h1>
        <div class="btn-group">
            <a href="{{ url_for('stats.library_journey') }}" class="btn btn-outline-primary">
                <i class="bi bi-diagram-3 me-1"></i>Journey Timeline
            </a>
            <a href="{{ url_for('stats.index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-graph-up me-1"></i>Full Stats
            </a>
        </div>
    </div>

    <!-- Library Stats with Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-10 col-md-9">
                            <div class="row text-center">
                                <div class="col-lg-2 col-md-4 col-6 mb-3 mb-lg-0">
                                    <button class="btn btn-outline-warning w-100 filter-btn" data-filter="reading">
                                        <div class="h4 mb-0 text-warning">{{ stats.currently_reading }}</div>
                                        <small class="text-muted">Currently Reading</small>
                                    </button>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3 mb-lg-0">
                                    <button class="btn btn-outline-success w-100 filter-btn" data-filter="read">
                                        <div class="h4 mb-0 text-success">{{ stats.books_read }}</div>
                                        <small class="text-muted">Books Read</small>
                                    </button>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3 mb-lg-0">
                                    <button class="btn btn-outline-info w-100 filter-btn" data-filter="plan_to_read">
                                        <div class="h4 mb-0 text-info">{{ stats.want_to_read }}</div>
                                        <small class="text-muted">Plan to Read</small>
                                    </button>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3 mb-lg-0">
                                    <button class="btn btn-outline-primary w-100 filter-btn" data-filter="wishlist">
                                        <div class="h4 mb-0 text-primary">{{ stats.wishlist }}</div>
                                        <small class="text-muted">Wishlist</small>
                                    </button>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3 mb-lg-0">
                                    <button class="btn btn-outline-secondary w-100 filter-btn" data-filter="on_hold">
                                        <div class="h4 mb-0 text-secondary">{{ stats.on_hold }}</div>
                                        <small class="text-muted">On Hold</small>
                                    </button>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6">
                                    <button class="btn btn-outline-dark w-100 filter-btn" data-filter="all">
                                        <div class="h4 mb-0 text-dark">{{ stats.total_books }}</div>
                                        <small class="text-muted">Total Books</small>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-3 text-center">
                            <a href="{{ url_for('main.add_book') }}" class="btn btn-success btn-lg">
                                <i class="bi bi-plus-circle me-1"></i>Add Books
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Filters (Collapsible) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#advancedFilters" 
                            aria-expanded="false" aria-controls="advancedFilters">
                        <i class="bi bi-funnel me-2"></i>Advanced Filters
                        <i class="bi bi-chevron-down float-end"></i>
                    </button>
                </div>
                <div id="advancedFilters" class="collapse">
                    <div class="card-body">
                        <form method="GET" id="filter-form">
                            <input type="hidden" name="status_filter" id="status_filter" value="{{ current_status_filter or 'all' }}">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="search" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="search" name="search" 
                                           value="{{ current_search }}" placeholder="Title, author, description...">
                                </div>
                                <div class="col-md-3">
                                    <label for="category" class="form-label">{{ get_genre_term() }}</label>
                                    <div class="dropdown-search-wrapper">
                                        <input type="hidden" name="category" value="{{ current_category }}">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start dropdown-search-btn" 
                                                    type="button" data-bs-toggle="dropdown" data-field="category">
                                                <span class="selected-text">{{ current_category if current_category else 'All ' + get_genre_term_plural() }}</span>
                                            </button>
                                            <ul class="dropdown-menu w-100 dropdown-search-menu" data-field="category">
                                                <li><input type="text" class="form-control dropdown-search-input" placeholder="Search categories..."></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" data-value="">All Categories</a></li>
                                                {% for category in categories %}
                                                    <li><a class="dropdown-item" href="#" data-value="{{ category }}">{{ category }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="publisher" class="form-label">Publisher</label>
                                    <div class="dropdown-search-wrapper">
                                        <input type="hidden" name="publisher" value="{{ current_publisher }}">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start dropdown-search-btn" 
                                                    type="button" data-bs-toggle="dropdown" data-field="publisher">
                                                <span class="selected-text">{{ current_publisher if current_publisher else 'All Publishers' }}</span>
                                            </button>
                                            <ul class="dropdown-menu w-100 dropdown-search-menu" data-field="publisher">
                                                <li><input type="text" class="form-control dropdown-search-input" placeholder="Search publishers..."></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" data-value="">All Publishers</a></li>
                                                {% for publisher in publishers %}
                                                    <li><a class="dropdown-item" href="#" data-value="{{ publisher }}">{{ publisher }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="language" class="form-label">Language</label>
                                    <div class="dropdown-search-wrapper">
                                        <input type="hidden" name="language" value="{{ current_language }}">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start dropdown-search-btn" 
                                                    type="button" data-bs-toggle="dropdown" data-field="language">
                                                <span class="selected-text">{{ current_language if current_language else 'All Languages' }}</span>
                                            </button>
                                            <ul class="dropdown-menu w-100 dropdown-search-menu" data-field="language">
                                                <li><input type="text" class="form-control dropdown-search-input" placeholder="Search languages..."></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" data-value="">All Languages</a></li>
                                                {% for language in languages %}
                                                    <li><a class="dropdown-item" href="#" data-value="{{ language }}">{{ language }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="location" class="form-label">Location</label>
                                    <div class="dropdown-search-wrapper">
                                        <input type="hidden" name="location" value="{{ current_location }}">
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start dropdown-search-btn" 
                                                    type="button" data-bs-toggle="dropdown" data-field="location">
                                                <span class="selected-text">{{ current_location if current_location else 'All Locations' }}</span>
                                            </button>
                                            <ul class="dropdown-menu w-100 dropdown-search-menu" data-field="location">
                                                <li><input type="text" class="form-control dropdown-search-input" placeholder="Search locations..."></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" data-value="">All Locations</a></li>
                                                {% for location in locations %}
                                                    <li><a class="dropdown-item" href="#" data-value="{{ location }}">{{ location }}</a></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="sort" class="form-label">Sort By</label>
                                    <select class="form-select" id="sort" name="sort">
                                        <option value="title_asc" {% if current_sort == 'title_asc' or not current_sort %}selected{% endif %}>Title A-Z</option>
                                        <option value="title_desc" {% if current_sort == 'title_desc' %}selected{% endif %}>Title Z-A</option>
                                        <option value="author_first_asc" {% if current_sort == 'author_first_asc' %}selected{% endif %}>Author First, Last A-Z</option>
                                        <option value="author_first_desc" {% if current_sort == 'author_first_desc' %}selected{% endif %}>Author First, Last Z-A</option>
                                        <option value="author_last_asc" {% if current_sort == 'author_last_asc' %}selected{% endif %}>Author Last, First A-Z</option>
                                        <option value="author_last_desc" {% if current_sort == 'author_last_desc' %}selected{% endif %}>Author Last, First Z-A</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="bi bi-funnel me-1"></i>Apply Filters
                                    </button>
                                    <a href="{{ url_for('main.library') }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Clear All
                                    </a>
                                    <span class="ms-3 text-muted">Showing <span id="book-count">{{ books|length }}</span> book(s)</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Books Grid -->
    <div class="row">
        <div class="col-12">
            {% if books %}
                <!-- Selection toolbar (hidden by default) -->
                <div id="selection-toolbar" class="card bg-primary text-white mb-3" style="display: none;">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <span id="selection-count">0</span> book(s) selected
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-light btn-sm me-2" onclick="selectAll()">
                                    Select All
                                </button>
                                <button type="button" class="btn btn-outline-light btn-sm me-2" onclick="clearSelection()">
                                    Clear Selection
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelected()">
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Books Grid -->
                <div class="row g-4" id="books-container">
                    {% for book in books %}
                        <div class="col-lg-2 col-md-3 col-sm-4 col-6 book-item" 
                             data-reading-status="{{ book.reading_status or 'library_only' }}"
                             data-ownership-status="{{ book.ownership_status or 'owned' }}">
                            <div class="card h-100 book-card shadow-sm" data-book-id="{{ book.uid }}">
                                <!-- Selection checkbox -->
                                <div class="position-absolute top-0 end-0 p-2" style="z-index: 10;">
                                    <input type="checkbox" class="form-check-input book-checkbox" value="{{ book.uid }}">
                                </div>

                                <!-- Book Cover -->
                                                                <!-- Book Cover -->
                                                                <div class="book-cover-wrapper position-relative" onclick="openBook('{{ book.uid }}')" style="cursor: pointer;">
                                    {% from 'macros/cover_input.html' import render_cover_display %}
                                    {{ render_cover_display(book, css_classes="card-img-top book-cover", style="", img_id="") }}
                                                                        {% if book.media_type and book.media_type|lower == 'audiobook' %}
                                                                            <span class="position-absolute bottom-0 end-0 m-2 badge rounded-pill bg-dark text-white opacity-75" title="Audiobook">
                                                                                <i class="bi bi-soundwave"></i>
                                                                            </span>
                                                                        {% endif %}
                                </div>

                                <!-- Book Info -->
                                <div class="card-body p-2" onclick="openBook('{{ book.uid }}')" style="cursor: pointer;">
                                    <h6 class="card-title mb-1 book-title">{{ book.title }}</h6>
                                    
                                    <!-- Author (simple display) -->
                                    {% if book.author %}
                                        <div class="mb-1 small text-muted">
                                            {{ book.author }}
                                        </div>
                                    {% endif %}

                                    <!-- Reading Status Badge -->
                                    <div class="mb-2">
                                        {% if book.reading_status == 'reading' %}
                                            <span class="badge bg-warning text-dark">üìñ Reading</span>
                                        {% elif book.reading_status == 'read' %}
                                            <span class="badge bg-success">‚úÖ Read</span>
                                        {% elif book.reading_status == 'plan_to_read' %}
                                            <span class="badge bg-info">üìö Plan to Read</span>
                                        {% elif book.reading_status == 'on_hold' %}
                                            <span class="badge bg-secondary">‚è∏Ô∏è On Hold</span>
                                        {% elif book.reading_status == 'did_not_finish' %}
                                            <span class="badge bg-danger">‚ùå DNF</span>
                                        {% endif %}

                                        {% if book.ownership_status == 'wishlist' %}
                                            <span class="badge bg-primary">‚≠ê Wishlist</span>
                                        {% elif book.ownership_status == 'borrowed' %}
                                            <span class="badge bg-warning">üìö Borrowed</span>
                                        {% elif book.ownership_status == 'loaned' %}
                                            <span class="badge bg-info">üì§ Loaned</span>
                                        {% endif %}
                                    </div>

                                    <!-- Rating -->
                                    {% if book.average_rating %}
                                        <div class="text-warning small">
                                            {% for i in range(5) %}
                                                {% if i < book.average_rating %}‚≠ê{% else %}‚òÜ{% endif %}
                                            {% endfor %}
                                            <span class="text-muted">{{ "%.2f"|format(book.average_rating) }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- No books message (hidden by default) -->
                <div id="no-books-message" class="text-center py-5" style="display: none;">
                    <div class="text-muted">
                        <i class="bi bi-book display-1"></i>
                        <p class="mt-3" id="no-books-text">No books found matching your current filter.</p>
                        <button class="btn btn-outline-primary" onclick="clearStatusFilter()">
                            Show All Books
                        </button>
                    </div>
                </div>

            {% else %}
                <!-- Empty state with context-aware message -->
                <div class="text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-book display-1"></i>
                        {% if current_status_filter == 'reading' %}
                            <h4 class="mt-3">You're not currently reading any books</h4>
                            <p class="mb-4">Start a new book from your library or add some books to read!</p>
                        {% elif current_status_filter == 'read' %}
                            <h4 class="mt-3">You haven't finished any books yet</h4>
                            <p class="mb-4">Complete some books and they'll appear here!</p>
                        {% elif current_status_filter == 'plan_to_read' %}
                            <h4 class="mt-3">You have no books planned to read</h4>
                            <p class="mb-4">Add some books to your reading list!</p>
                        {% elif current_status_filter == 'wishlist' %}
                            <h4 class="mt-3">You have no books on your wishlist</h4>
                            <p class="mb-4">Add books you want to acquire to your wishlist!</p>
                        {% elif current_status_filter == 'on_hold' %}
                            <h4 class="mt-3">You have no books on hold</h4>
                            <p class="mb-4">Books you've paused will appear here!</p>
                        {% else %}
                            <h4 class="mt-3">No books found</h4>
                            <p class="mb-4">Try adjusting your filters or add some books to your library!</p>
                        {% endif %}
                        <a href="{{ url_for('main.add_book') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-1"></i>Add Books
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bulk Delete Form (hidden) -->
    <form id="bulk-delete-form" method="POST" action="{{ url_for('main.bulk_delete_books') }}" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize with the current filter from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentFilter = urlParams.get('status_filter') || 'all';  // Changed default to 'all'
    
    // Set active filter button
    updateActiveFilter(currentFilter);
    
    // Apply initial filter
    applyStatusFilter(currentFilter);

    // Filter button handlers
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.dataset.filter;
            
            // Get the current active filter from URL or default to 'all'
            const urlParams = new URLSearchParams(window.location.search);
            const currentActiveFilter = urlParams.get('status_filter') || 'all';
            
            // If clicking the same filter that's already active, toggle to 'all'
            const targetFilter = (filter === currentActiveFilter) ? 'all' : filter;
            
            applyStatusFilter(targetFilter);
            updateActiveFilter(targetFilter);
            
            // Update URL without page reload
            const url = new URL(window.location);
            if (targetFilter === 'all') {
                url.searchParams.delete('status_filter');
            } else {
                url.searchParams.set('status_filter', targetFilter);
            }
            window.history.pushState({}, '', url);
        });
    });

    // Selection functionality
    const checkboxes = document.querySelectorAll('.book-checkbox');
    const selectionToolbar = document.getElementById('selection-toolbar');
    const selectionCount = document.getElementById('selection-count');

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionUI);
    });

    function updateSelectionUI() {
        const selected = document.querySelectorAll('.book-checkbox:checked');
        const count = selected.length;
        
        selectionCount.textContent = count;
        selectionToolbar.style.display = count > 0 ? 'block' : 'none';
    }

    // Global functions for inline handlers
    window.selectAll = function() {
        const visibleCheckboxes = document.querySelectorAll('.book-item:not([style*="display: none"]) .book-checkbox');
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateSelectionUI();
    };

    window.clearSelection = function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectionUI();
    };

    // Sort dropdown change handler
    const sortDropdown = document.getElementById('sort');
    if (sortDropdown) {
        sortDropdown.addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
    }

    // Searchable dropdown functionality
    initializeSearchableDropdowns();

    window.deleteSelected = function() {
        const selected = document.querySelectorAll('.book-checkbox:checked');
        if (selected.length === 0) return;
        
        if (confirm(`Are you sure you want to delete ${selected.length} book(s) from your library?`)) {
            const form = document.getElementById('bulk-delete-form');
            
            // Clear existing inputs
            form.querySelectorAll('input[name="book_ids"]').forEach(input => input.remove());
            
            // Add selected book IDs
            selected.forEach(checkbox => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'book_ids';
                input.value = checkbox.value;
                form.appendChild(input);
            });
            
            form.submit();
        }
    };

    window.openBook = function(uid) {
        if (!uid) {
            console.error('No UID provided for book');
            return;
        }
        console.log('Opening book with UID:', uid);
        var baseUrl = "{{ url_for('main.view_book_enhanced', uid='PLACEHOLDER') }}";
        var bookUrl = baseUrl.replace('PLACEHOLDER', uid);
        console.log('Navigating to:', bookUrl);
        window.location.href = bookUrl;
    };

    window.clearStatusFilter = function() {
        applyStatusFilter('all');
        updateActiveFilter('all');
    };
});

function applyStatusFilter(filter) {
    const books = document.querySelectorAll('.book-item');
    const noBooks = document.getElementById('no-books-message');
    const noBooksText = document.getElementById('no-books-text');
    let visibleCount = 0;

    books.forEach(book => {
        const readingStatus = book.dataset.readingStatus;
        const ownershipStatus = book.dataset.ownershipStatus;
        let shouldShow = false;

        switch(filter) {
            case 'all':
                shouldShow = true;
                break;
            case 'reading':
                shouldShow = readingStatus === 'reading';
                break;
            case 'read':
                shouldShow = readingStatus === 'read';
                break;
            case 'plan_to_read':
                shouldShow = readingStatus === 'plan_to_read';
                break;
            case 'on_hold':
                shouldShow = readingStatus === 'on_hold';
                break;
            case 'wishlist':
                shouldShow = ownershipStatus === 'wishlist';
                break;
        }

        if (shouldShow) {
            book.style.display = '';
            visibleCount++;
        } else {
            book.style.display = 'none';
        }
    });

    // Update book count
    document.getElementById('book-count').textContent = visibleCount;
    
    // Update no books message based on filter
    if (visibleCount === 0) {
        let message = 'No books found matching your current filter.';
        switch(filter) {
            case 'reading':
                message = "You're not currently reading any books.";
                break;
            case 'read':
                message = "You haven't finished any books yet.";
                break;
            case 'plan_to_read':
                message = "You have no books planned to read.";
                break;
            case 'on_hold':
                message = "You have no books on hold.";
                break;
            case 'wishlist':
                message = "You have no books on your wishlist.";
                break;
            case 'all':
                message = "Your library is empty.";
                break;
        }
        noBooksText.textContent = message;
    }
    
    // Show/hide no books message
    noBooks.style.display = visibleCount === 0 ? 'block' : 'none';
    
    // Update hidden form field
    document.getElementById('status_filter').value = filter;
}

function updateActiveFilter(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filter === filter) {
            btn.classList.remove('btn-outline-warning', 'btn-outline-success', 'btn-outline-info', 'btn-outline-primary', 'btn-outline-secondary', 'btn-outline-dark');
            if (filter === 'reading') btn.classList.add('btn-warning');
            else if (filter === 'read') btn.classList.add('btn-success');
            else if (filter === 'plan_to_read') btn.classList.add('btn-info');
            else if (filter === 'wishlist') btn.classList.add('btn-primary');
            else if (filter === 'on_hold') btn.classList.add('btn-secondary');
            else btn.classList.add('btn-dark');
        } else {
            btn.classList.remove('btn-warning', 'btn-success', 'btn-info', 'btn-primary', 'btn-secondary', 'btn-dark');
            if (btn.dataset.filter === 'reading') btn.classList.add('btn-outline-warning');
            else if (btn.dataset.filter === 'read') btn.classList.add('btn-outline-success');
            else if (btn.dataset.filter === 'plan_to_read') btn.classList.add('btn-outline-info');
            else if (btn.dataset.filter === 'wishlist') btn.classList.add('btn-outline-primary');
            else if (btn.dataset.filter === 'on_hold') btn.classList.add('btn-outline-secondary');
            else btn.classList.add('btn-outline-dark');
        }
    });
}

function initializeSearchableDropdowns() {
    // Initialize all searchable dropdowns
    document.querySelectorAll('.dropdown-search-menu').forEach(menu => {
        const field = menu.dataset.field;
        const button = document.querySelector(`[data-field="${field}"].dropdown-search-btn`);
        const hiddenInput = document.querySelector(`input[name="${field}"]`);
        const searchInput = menu.querySelector('.dropdown-search-input');
        const allItems = menu.querySelectorAll('.dropdown-item');
        
        if (!button || !hiddenInput || !searchInput) return;
        
        // Handle search input
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            allItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                const li = item.parentElement;
                
                if (text.includes(searchTerm) || item.dataset.value === '') {
                    li.style.display = '';
                } else {
                    li.style.display = 'none';
                }
            });
        });
        
        // Prevent dropdown from closing when clicking on search input
        searchInput.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Handle item selection
        allItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const value = this.dataset.value;
                const text = this.textContent;
                
                // Update hidden input
                hiddenInput.value = value;
                
                // Update button text
                const selectedText = button.querySelector('.selected-text');
                selectedText.textContent = text;
                
                // Close dropdown
                const dropdown = new bootstrap.Dropdown(button);
                dropdown.hide();
                
                // Clear search
                searchInput.value = '';
                allItems.forEach(item => {
                    item.parentElement.style.display = '';
                });
                
                // Mark as active
                allItems.forEach(item => item.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Set initial active item
        const currentValue = hiddenInput.value;
        allItems.forEach(item => {
            if (item.dataset.value === currentValue) {
                item.classList.add('active');
            }
        });
        
        // Clear search when dropdown is closed
        button.addEventListener('hidden.bs.dropdown', function() {
            searchInput.value = '';
            allItems.forEach(item => {
                item.parentElement.style.display = '';
            });
        });
        
        // Focus search input when dropdown opens
        button.addEventListener('shown.bs.dropdown', function() {
            searchInput.focus();
        });
    });
}
</script>

{% endblock %}
