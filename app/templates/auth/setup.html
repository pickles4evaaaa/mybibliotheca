{% extends "base.html" %}

{% block title %}Initial Setup - MyBibliotheca{% endblock %}

{% block content %}
<style>
/* Dark mode improvements for setup page */
[data-theme="dark"] .card {
    background-color: var(--bs-dark);
    border-color: #495057;
}

[data-theme="dark"] .card-header {
    background-color: #495057;
    border-bottom-color: #6c757d;
}

[data-theme="dark"] .text-muted {
    color: #adb5bd !important;
}

[data-theme="dark"] .form-text {
    color: #adb5bd !important;
}

[data-theme="dark"] .alert-info {
    background-color: #0f3460;
    border-color: #084298;
    color: #b6d7ff;
}

[data-theme="dark"] .alert-success {
    background-color: #0f5132;
    border-color: #0a58ca;
    color: #a3cfbb;
}

[data-theme="dark"] .alert-warning {
    background-color: #664d03;
    border-color: #ffca2c;
    color: #ffda6a;
}

[data-theme="dark"] .form-control {
    background-color: #495057;
    border-color: #6c757d;
    color: #fff;
}

[data-theme="dark"] .form-control:focus {
    background-color: #495057;
    border-color: #86b7fe;
    color: #fff;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

[data-theme="dark"] .form-label {
    color: #f8f9fa;
}

[data-theme="dark"] .progress {
    background-color: #495057;
}

[data-theme="dark"] .progress-bar {
    background-color: #0d6efd;
}

/* Ensure readability for all alert content */
[data-theme="dark"] .alert h6 {
    color: inherit;
}

[data-theme="dark"] .alert ul li {
    color: inherit;
}

[data-theme="dark"] .alert-info .fas {
    color: #b6d7ff;
}

[data-theme="dark"] .alert-success .fas {
    color: #a3cfbb;
}

[data-theme="dark"] .alert-warning .fas {
    color: #ffda6a;
}
</style>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header text-center">
                <h4>ðŸ“š Welcome to MyBibliotheca</h4>
                <p class="mb-0 text-muted">Initial Setup Required</p>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> First Time Setup</h6>
                    <p class="mb-0">
                        Welcome! This appears to be your first time running MyBibliotheca. 
                        Please create an administrator account to get started.
                    </p>
                </div>

                <!-- Progress indicator -->
                <div class="progress mb-4" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted">Step 1 of 3: Create Administrator Account</small>

                <form method="POST" id="setup-form">
                    {{ form.hidden_tag() }}
                    
                    <!-- Add visual feedback for CSRF token -->
                    {% if form.csrf_token.errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Security Error:</strong> The form session has expired. Please refresh the page and try again.
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), required=true, autocomplete="username") }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.username.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">This will be your administrator username (3-20 characters)</small>
                    </div>

                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else ""), required=true, autocomplete="email") }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Administrator email address</small>
                    </div>

                    <div class="mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else "")) }}
                        {% if form.password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="alert alert-info mt-2" role="alert">
                            <h6><i class="fas fa-shield-alt"></i> Password Requirements:</h6>
                            <ul class="mb-0">
                                {% for requirement in password_requirements %}
                                <li>{{ requirement }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <div class="mb-4">
                        {{ form.password2.label(class="form-label") }}
                        {{ form.password2(class="form-control" + (" is-invalid" if form.password2.errors else "")) }}
                        {% if form.password2.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.password2.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-search"></i> Automatic Migration Detection</h6>
                        <p class="mb-0">
                            The system will automatically check for existing SQLite databases during setup.
                            If found, you'll be guided through importing your existing library data.
                        </p>
                    </div>

                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary btn-lg", id="setup-submit-btn") }}
                    </div>
                </form>

                <div class="alert alert-success mt-4">
                    <h6><i class="fas fa-check-circle"></i> After Setup</h6>
                    <p class="mb-0">
                        Once you complete this setup, you'll be able to log in as an administrator 
                        and start adding books to your library. You can create additional user accounts 
                        from the admin panel.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('setup-form');
    const submitBtn = document.getElementById('setup-submit-btn');
    let isSubmitting = false;
    
    // Add form validation
    form.addEventListener('submit', function(e) {
        if (isSubmitting) {
            e.preventDefault();
            return false;
        }
        
        // Basic client-side validation
        const username = form.querySelector('[name="username"]').value.trim();
        const email = form.querySelector('[name="email"]').value.trim();
        const password = form.querySelector('[name="password"]').value;
        const password2 = form.querySelector('[name="password2"]').value;
        
        if (username.length < 3) {
            alert('Username must be at least 3 characters long.');
            e.preventDefault();
            return false;
        }
        
        if (!email.includes('@')) {
            alert('Please enter a valid email address.');
            e.preventDefault();
            return false;
        }
        
        if (password.length < 8) {
            alert('Password must be at least 8 characters long.');
            e.preventDefault();
            return false;
        }
        
        if (password !== password2) {
            alert('Passwords do not match.');
            e.preventDefault();
            return false;
        }
        
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating Admin Account...';
        
        // Re-enable after 30 seconds as a safety fallback
        setTimeout(function() {
            if (isSubmitting) {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Complete Setup';
            }
        }, 30000);
    });
    
    // Handle browser back/forward navigation
    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Complete Setup';
        }
    });
    
    // Auto-refresh CSRF token if page is idle for too long (25 minutes)
    let idleTimer;
    function resetIdleTimer() {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(function() {
            if (!isSubmitting) {
                // Warn user about potential CSRF expiration
                const warningDiv = document.createElement('div');
                warningDiv.className = 'alert alert-warning mt-3';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> This form has been open for a while. If you encounter errors, please refresh the page.';
                form.insertBefore(warningDiv, form.firstChild);
            }
        }, 25 * 60 * 1000); // 25 minutes
    }
    
    // Reset timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(function(event) {
        document.addEventListener(event, resetIdleTimer, true);
    });
    
    resetIdleTimer();
});
</script>
{% endblock %}
